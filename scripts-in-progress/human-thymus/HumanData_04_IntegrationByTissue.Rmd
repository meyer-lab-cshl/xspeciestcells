---
title: "Human data - Integrate data by tissue"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(root.dir = "~/Projects/HumanThymusProject/scripts/human-thymus/")
```


## 1. Import

```{r import-librairies, message=FALSE}
# Libraries
library(ggplot2)
library(cowplot)
library(Seurat)
library(SeuratWrappers)
library(harmony)
library(tidyverse)
```

```{r import-data}
# Data
seur.filt <- readRDS("~/Projects/HumanThymusProject/data/CLUSTER/seurat-integration/input/seur_filt_22-12-19.rds")
print(seur.filt) # 80,614 cells and 17,212 genes
print(head(seur.filt@meta.data))
```




## 2. Preprocessing

### a) QC

Quality-control has probably been done already by Laurent.

```{r qc}
# Data was already quality-filtered (in HumanData_09_PreprocessingPipelinesComparison)
FeatureScatter(seur.filt, feature1 = "nCount_RNA", feature2 = "nFeature_RNA", group.by="Method")
VlnPlot(seur.filt, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, pt.size=.01, group.by="Batch")


# Look at distribution of #cells in which each feature is expressed
counts <- GetAssayData(object = seur.filt, slot = "counts")
nonzerocounts <- counts>0
hist(rowSums(nonzerocounts), breaks=1000)
hist(rowSums(nonzerocounts), breaks=1000000, xlim=c(0,100)) # features are expressed in at least 18 cells
```



### b) Separate blood and thymus data

```{r split-data}
seur.thymus <- subset(seur.filt, subset= Tissue=="Thymus")
print(seur.thymus) # 39,623 cells
table(seur.thymus$Batch)

seur.PBMC <- subset(seur.filt, subset= Tissue=="PBMC")
print(seur.PBMC) # 40,991 cells
```



## 2. Integration of Thymus data

### a) Normalize

```{r normalize-thymus}
# Run standard workflow for PCA
seur.thymus <- NormalizeData(seur.thymus)
seur.thymus <- FindVariableFeatures(seur.thymus, selection.method="vst", nfeatures=2000)
seur.thymus <- ScaleData(seur.thymus)
seur.thymus <- RunPCA(seur.thymus, npcs=50, verbose=T)
ElbowPlot(seur.thymus, ndims=50, reduction="pca")
DimPlot(seur.thymus, reduction="pca", group.by=c("Tissue", "Batch", "Method"))
```


### b) Integrate with Harmony

```{r thymus-integration}
seur.thymus <- RunHarmony(seur.thymus,
                           reduction = "pca",
                           max.iter.harmony=30,
                           group.by.vars = c("Method", "Batch")) # converged in 13 iterations
DimPlot(seur.thymus, reduction="pca", group.by="Batch") | DimPlot(seur.thymus, reduction="harmony", group.by="Batch")
DimPlot(seur.thymus, reduction="pca", group.by="Method") | DimPlot(seur.thymus, reduction="harmony", group.by="Method")
DimPlot(seur.thymus, reduction="pca", group.by="Sex") | DimPlot(seur.thymus, reduction="harmony", group.by="Sex")

ElbowPlot(seur.thymus, ndims=50, reduction="harmony")
seur.thymus <- RunUMAP(seur.thymus, reduction = "harmony", dims = 1:20, n.neighbors=50)
seur.thymus <- FindNeighbors(seur.thymus, reduction = "harmony", dims = 1:20, k.param=50)
seur.thymus <- FindClusters(seur.thymus, resolution = 0.2)
```


### c) Plot

```{r thymus-visualize}
a <- DimPlot(seur.thymus, group.by = "Batch", pt.size = 0.1, repel=T) + theme(legend.position = "bottom")
b <- DimPlot(seur.thymus, group.by = "Method", pt.size = 0.1, repel=T) + theme(legend.position = "bottom")
c <- DimPlot(seur.thymus, group.by = "cell.ident", pt.size = 0.1)+
  scale_color_manual(values=RColorBrewer::brewer.pal(7, "Paired")) + theme(legend.position = "bottom")
d <- DimPlot(seur.thymus, group.by = "seurat_clusters", pt.size = 0.1, label=T, repel=T) + theme(legend.position = "none")
e <- DimPlot(seur.thymus, group.by = "cell.ident", split.by = "Batch", pt.size = 0.1, repel=T)+
  scale_color_manual(values=RColorBrewer::brewer.pal(7, "Paired"))+
  ggtitle("Donor batch")

ggpubr::ggarrange(ggpubr::ggarrange(a,b,c,d, ncol=4),
                  e, nrow=2)
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_04_IntegrationByTissue/thymus_umap.jpeg", width=14, height=9)
```


### d) Cluster markers

```{r thymus-markers}
# Get markers
# FindAllMarkers(seur.thymus, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, assay="SCT")

# Make DotPlot
DotPlot(seur.thymus,
        features=c("PTCRA", "RAG1", "CD1C", "AQP3", "CD8A", "PDCD1", "GNG4",
                   "TRDC", "TRGC2", "EGR1", "EGR3", "NR4A1", "IKZF4", "FOXP3"))+
  # theme(axis.text.x=element_text(angle=45, hjust=1))+
  coord_flip()

# Make DotPlot inspired from Park et al
DotPlot(seur.thymus,
        features=rev(c("CD8A", "CD8B", # CD8+
                   "CD4", "CD40LG", # CD4+
                   "IKZF4", "GNG8", "PTGIR", "PLN", "FOXP3", "CTLA4", "PRDM1", "MIR155HG", # Treg
                   "PDCD1", "GNG4", "CREB3L3", "CD72", "ZNF683", "MME", #CD8aa
                   "KLRB1", "ZBTB16", "NKG7", "EOMES", "IFNG", "TBX21", "RORC", "CCR6", # innate
                   "KLF2", # exit
                   "TNFRSF9", "CD27", "IKZF2", "IKZF3")))+ # agonist selection
  # theme(axis.text.x=element_text(angle=45, hjust=1))+
  coord_flip()
```

