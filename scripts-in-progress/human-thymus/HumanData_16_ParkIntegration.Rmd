---
title: "Human T cell data - Integrate with Park data"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```




## 1. IMPORT

### 1.1. Import librairies
```{r import-librairies, message=FALSE}
library(ggplot2)
library(gplots)
library(cowplot)
library(tidyverse)
library(dplyr)
library(Seurat)
library(RColorBrewer)
library(harmony)
# library(corrplot)
# library(pals)
# library(VennDiagram)
library(ggVennDiagram)
library(MetaNeighbor)
library(SummarizedExperiment)
# library(ggalluvial)
# library(SingleCellExperiment)
```


### 1.2. Import data
```{r import-data, fig.height=8, fig.width=8}
# Import seurat object
seur <- readRDS("~/Projects/HumanThymusProject/data/raw_data/human_data/seurat_filtered_harmony_02_15_23.RDS") # removed low-quality cells

# Sanity check
print(seur) # 78,607 cells
cols_integrated <- c("0" = "#f4c40f", "1" = "#b75347", "2" = "#d8443c", "3" = "#e09351", "4" = "#2b9b81", 
                     "5" = "#421401", "6" = "#92c051", "7" = "#9f5691", "8" = "#17154f", "9" = "#74c8c3", 
                     "10" = "#5a97c1", "11" = "gold", "12" = "#a40000", "13" = "#72bcd5", "14" = "grey50",
                     "15" = "orange", "16" = "blueviolet", "17" = "#0a2e57", "18" = "#bdbdbd")
SCpubr::do_DimPlot(seur, 
                   group.by = "new_clusters",
                   label=T,
                   label.color="black",
                   legend.position = "none",
                   repel=T,
                   colors.use=cols_integrated,
                   font.size = 24)
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/gapin_umap.jpeg", width=10, height=8)
```


### 1.3. Import entire Park data
```{r import-park, fig.height=8, fig.width=8}
# seur.park <- readRDS("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/park_full_seurat.rds")
seur.park <- readRDS("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/park_full_seu_gene_names.rds")

# Sanity check
SCpubr::do_DimPlot(seur.park,
                   group.by = "cell_type",
                   label=T,
                   label.color="black",
                   legend.position = "none",
                   repel=T,
                   font.size = 24)
table(seur.park$cell_type, useNA="ifany")

# check out gene names
rownames(seur.park)[1:5]

# check out overlap gene names between Park data and our data
ggVennDiagram(
  x=list(rownames(seur), rownames(seur.park)),
  category.names = c("Gapin" , "Park"),
  label_alpha=0,
  label="count"
)+
  ggplot2::scale_fill_gradient(low="white",high = "blue")


# Add better cell_type to full park seurat object
park_metadata <- read.csv("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/park_metadata.csv")

seur.park2 <- seur.park
table(park_metadata$index %in% rownames(seur.park2@meta.data)) # only 76,903 cells common
park_metadata.sub <- park_metadata[park_metadata$index %in% rownames(seur.park2@meta.data),]
table(park_metadata.sub$index %in% rownames(seur.park2@meta.data)) # only 76,903 cells common

table(park_metadata.sub$index == rownames(seur.park2@meta.data[park_metadata.sub$index,])) # yessss nice
seur.park2@meta.data$cell_type <- as.character(seur.park2@meta.data$cell_type)
table(seur.park2@meta.data[park_metadata.sub$index,"cell_type"], useNA="ifany")
seur.park2@meta.data[park_metadata.sub$index,"cell_type"] <- park_metadata.sub$cell.types
table(seur.park2$cell_type, useNA="ifany")

SCpubr::do_DimPlot(seur.park2,
                   group.by = "cell_type",
                   label=T,
                   label.color="black",
                   legend.position = "none",
                   repel=T,
                   font.size = 24)

# Sanity check
as.data.frame(table(seur.park$cell_type, useNA="ifany")) %>%
  dplyr::rename(freq_before=Freq, celltype=Var1) %>%
  full_join(as.data.frame(table(seur.park2$cell_type, useNA="ifany")) %>% dplyr::rename(freq_after=Freq, celltype=Var1),
            by="celltype", keep=T) %>%
  replace_na(list(freq_before=0)) %>%
  select(-celltype.x) %>%
  filter(freq_before != freq_after)
```


### 1.4. Import Park data (thymocytes only)
Downloading the seurat object from [here](https://cellxgene.cziscience.com/collections/de13e3e2-23b6-40ed-a413-e9e12d7d3910).
```{r import-park-thymocytes, fig.height=8, fig.width=8}
seur.park.thymocytes <- readRDS("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/park_thymus_seu_gene_names.rds")

# Sanity check
SCpubr::do_DimPlot(seur.park.thymocytes,
                   group.by = "cell_type",
                   label=T,
                   label.color="black",
                   legend.position = "none",
                   repel=T,
                   font.size = 24)
# DimPlot(seur.park.thymocytes, group.by="cell_type", label=T)

seur.park.thymocytes@meta.data$study <- "park_data"
seur.park.thymocytes@meta.data
```

```{r, fig.height=8, fig.width=10}
# Plot CCR9-CCR7
SCpubr::do_FeaturePlot(seur.park.thymocytes, 
                       order=T,
                       viridis_color_map="A",
                       slot="data",
                       legend.position="right",
                       ncol=2,
                       features = c("CCR9", "CCR7"))
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_14_CCR9-CCR7-plots/park_ccr9-ccr7.jpeg", width=20, height=10)

# Plot scores
seur.park.thymocytes <- AddModuleScore(object = seur.park.thymocytes, assay = "RNA", features = list("effector"=effectorness_genes, "naive"=naive_genes, "egress"=egress_genes), name=c("effector", "naive", "egress"))

SCpubr::do_FeaturePlot(seur.park.thymocytes, 
                       order=T,
                       viridis_color_map="A",
                       slot="data",
                       legend.position="right",
                       ncol=3,
                       features = c("effector1", "naive2", "egress3"))
```


Some cell type annotation is clearly missing. I thus downloaded the AnnData object from the [developmental cell atlas](https://developmental.cellatlas.io/thymus-development). Here we are converting the AnnData object to seurat object.

```{r import-park-thymocytes2}
# Install SeuratDisk
# if (!requireNamespace("remotes", quietly = TRUE)) {
#   install.packages("remotes")
# }
# remotes::install_github("mojaveazure/seurat-disk")
library(SeuratDisk)

# Convert anndata object to seurat
# Convert("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/HTA08_v01_A06_Science_human_tcells.gzip.h5ad",
#         dest = "h5seurat",
#         overwrite = TRUE)
# seur.park.thymocytes2 <- LoadH5Seurat("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/HTA08_v01_A06_Science_human_tcells.gzip.h5seurat")


# Try with anndata for R
# reticulate::install_miniconda()
# anndata::install_anndata()
# library(anndata)
# library(reticulate)
# import_from_path("anndata", path="/Users/scarcy/opt/anaconda3/lib/python3.8/site-packages/")
# data <- read_h5ad("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/HTA08_v01_A06_Science_human_tcells.h5ad", backed="r+")
# data <- CreateSeuratObject(counts = t(data$X), meta.data = data$obs)
# print(str(data))
# 
# # Visualize
# DimPlot(test, group.by="cell_type", label=T)
```

Okay it's complicated to convert the AnnData, so let's get the metadata lol

```{r park-thymocyte-add-celltype}
park_metadata <- read.csv("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/park_metadata.csv")

# Check that the row names are the same
table(park_metadata$index == rownames((seur.park.thymocytes@meta.data))) # yessss nice

# Get the cell types eheheh
seur.park.thymocytes@meta.data$cell_type <- park_metadata$cell.types


# Visualize
cols_park <- c("DN(early)" = "#78c679",
               "DN(P)" = "#41ab5d",
               "DN(Q)" = "#238443",
               "γδT" = "#92c051",
               "DP(P)" = "#b75347",
               "DP(Q)" = "#d8443c",
               "αβT(entry)" = "#e09351",
               "CD8+T"= "#5a97c1",
               "CD8αα(I)" = "#421401",
               "CD8αα(II)" = "#0a2e57",
               "CD4+T"= "gold",
               "T(agonist)" = "#9f5691",
               "Treg(diff)" = "#9f5691",
               "Treg" = "blueviolet",
               "Th17" = "#a40000",
               "NKT" = "#72bcd5")
DimPlot(seur.park.thymocytes, group.by="cell_type", label=T)+
  scale_color_manual(values=cols_park)

# SCpubr::do_DimPlot(seur.park.thymocytes,
#                    group.by = "cell_type",
#                    pt.size=0.5,
#                    label=T,
#                    label.color="black",
#                    legend.position = "none",
#                    repel=T,
#                    colors.use=cols_park,
#                    font.size = 24)
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/park_umap2.jpeg", width=10, height=9)

# Check gene names
rownames(seur.park.thymocytes)[1:5]
```




## 2. INTEGRATION WITH PARK DATA

### 2.1. Cleanup data
Keep only cells of interest in each dataset
```{r cleanup-gapin-data}
# Keep only thymus
Idents(seur) <- "Tissue"
seur.thymus <- subset(seur, ident="Thymus")
DimPlot(seur.thymus, group.by="new_clusters", cols=cols_integrated, reduction="UMAP_50", label=T)
SCpubr::do_DimPlot(seur.thymus, 
                   group.by = "new_clusters",
                   label=T,
                   label.color="black",
                   legend.position = "none",
                   repel=T,
                   colors.use=cols_integrated,
                   font.size = 24)
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/gapin_umap_thymus.jpeg", width=10, height=10)

# Call the clusters "c0", "c1", etc.
colnames(seur.thymus@meta.data)[17] <- "cell_type"
seur.thymus@meta.data[,"cell_type"] <- paste0("c",seur.thymus@meta.data[,"cell_type"])
seur.thymus@meta.data$study <- "gapin_data"

DimPlot(seur.thymus, group.by="cell_type", reduction="UMAP_50", label=T)
```

```{r cleanup-park, fig.height=8, fig.width=20}
# Sanity check
DimPlot(seur.park, group.by="cell_type", label=T)

# Keep only thymocytes
seur.park@meta.data
table(seur.park$development_stage)
table(seur.park$cell_type)
Idents(seur.park) <- "cell_type"
seur.parkT <- subset(seur.park, idents=c("fibroblast", "mast cell", "endothelial cell", "erythrocyte", "macrophage", "vascular associated smooth muscle cell",
                                         "dendritic cell", "lymphocyte", "megakaryocyte", "monocyte", "plasmacytoid dendritic cell", "plasma cell", "memory B cell",
                                         "naive B cell", "precursor B cell", "epithelial cell of thymus", "cortical thymic epithelial cell",
                                         "medullary thymic epithelial cell", "progenitor cell"), invert=TRUE)
DimPlot(seur.parkT, group.by="cell_type", label=T)

# Rename the cell_types
seur.parkT@meta.data$cell_type <- case_when(
  seur.parkT@meta.data$cell_type == "CD4-positive, alpha-beta T cell" ~ "CD4+ T",
  seur.parkT@meta.data$cell_type == "CD8-positive, alpha-beta T cell" ~ "CD8+ T",
  seur.parkT@meta.data$cell_type == "alpha-beta T cell" ~ "abT",
  seur.parkT@meta.data$cell_type == "gamma-delta T cell" ~ "gdT",
  seur.parkT@meta.data$cell_type == "double-positive, alpha-beta thymocyte" ~ "DP",
  seur.parkT@meta.data$cell_type == "regulatory T cell" ~ "Treg",
  seur.parkT@meta.data$cell_type == "CD4-positive, alpha-beta memory T cell" ~ "CD4+ Tmem",
  seur.parkT@meta.data$cell_type == "CD8-positive, alpha-beta memory T cell" ~ "CD8+ Tmem",
  seur.parkT@meta.data$cell_type == "CD8-alpha-alpha-positive, alpha-beta intraepithelial T cell" ~ "CD8aa, ab IEL",
  seur.parkT@meta.data$cell_type == "group 3 innate lymphoid cell" ~ "ILC3",
  seur.parkT@meta.data$cell_type == "double negative thymocyte" ~ "DN",
  seur.parkT@meta.data$cell_type == "T cell" ~ "T cell",
  seur.parkT@meta.data$cell_type == "natural killer cell" ~ "natural killer cell",
  seur.parkT@meta.data$cell_type == "early T lineage precursor" ~ "ETP"
)

DimPlot(seur.parkT, group.by="cell_type", label=T)

# Add information of dataset
seur.parkT@meta.data$study <- "park_data"
```


### 2.2. Metaneighbor on whole Park data
```{r park-metaneighbor}
# Get union of HVGs from our data & park data
length(VariableFeatures(seur.thymus))
seur.parkT <- FindVariableFeatures(seur.parkT, nfeatures = 2000)
length(VariableFeatures(seur.parkT))

ggVennDiagram(
  x=list(VariableFeatures(seur.thymus), VariableFeatures(seur.parkT)),
  category.names = c("Gapin HVGs" , "Park HVGs"),
  label_alpha=0,
  label="count"
)+
  ggplot2::scale_fill_gradient(low="white",high = "blue")

hvg.union <- unique(c(VariableFeatures(seur.thymus), VariableFeatures(seur.parkT)))
length(hvg.union)


# Merge seurat objects
seur.merged <- merge(seur.thymus, y=seur.parkT)
# sanity checks
ncol(seur.thymus) + ncol(seur.parkT) # total nb of samples
length(union(rownames(seur.thymus), rownames(seur.parkT))) # total nb of genes
print(seur.merged)


# Convert seurat count matrix to SummarizedExperiment object
table(seur.merged$cell_type, useNA="ifany")
table(seur.merged$study, useNA="ifany")
count <- SummarizedExperiment(assays=seur.merged@assays[["RNA"]]@counts,
                              colData=seur.merged@meta.data[,c("cell_type", "study")])

# sanity check
# table(colnames(seur.merged@assays[["RNA"]]@counts) == rownames(seur.merged@meta.data))


# Run metaneighbor
mtn <- MetaNeighborUS(var_genes=hvg.union,
                      dat=count,
                      study_id=seur.merged$study,
                      cell_type=seur.merged$cell_type,
                      fast_version=TRUE)

# Rename rows & cols
# rownames(mtn) <- gsub(".*\\|", "", rownames(mtn))
# colnames(mtn) <- gsub(".*\\|", "", colnames(mtn))

# Heatmap
jpeg("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/metaneighbor_thymocytes.jpeg",
     width=1000, height=1000, res=150)
heatmap.2(mtn,
          # trace
          trace="none",
          # superimpose a density histogram on color key
          density.info="none",
          # color scale
          col=rev(colorRampPalette(brewer.pal(11,"RdYlBu"))(100)),
          breaks=seq(0,1,length=101),
          # text labels
          main="Integration on whole data",
          cexRow=0.6,
          cexCol=0.6,
          # margins
          margins=c(7,7))
dev.off()
```



### 2.3. Metaneighbor on T cell Park data
```{r park-metaneighbor}
# Get union of HVGs from our data & park data
length(VariableFeatures(seur.thymus))
seur.park.thymocytes <- FindVariableFeatures(seur.park.thymocytes, nfeatures = 2000)
length(VariableFeatures(seur.park.thymocytes))

ggVennDiagram(
  x=list(VariableFeatures(seur.thymus), VariableFeatures(seur.park.thymocytes)),
  category.names = c("Gapin HVGs" , "Park HVGs"),
  label_alpha=0,
  label="count"
)+
  ggplot2::scale_fill_gradient(low="white",high = "blue") # 573 common HVGs

hvg.union2 <- unique(c(VariableFeatures(seur.thymus), VariableFeatures(seur.park.thymocytes)))
length(hvg.union2) # 3,427 genes


# Merge seurat objects
seur.park.thymocytes$study <- "park_data"
seur.merged2 <- merge(seur.thymus, y=seur.park.thymocytes)
# sanity checks
ncol(seur.thymus) + ncol(seur.park.thymocytes) # total nb of samples
length(union(rownames(seur.thymus), rownames(seur.park.thymocytes))) # total nb of genes
print(seur.merged2)


# Convert seurat count matrix to SummarizedExperiment object
table(seur.merged2$cell_type, useNA="ifany")
table(seur.merged2$study, useNA="ifany")
count2 <- SummarizedExperiment(assays=seur.merged2@assays[["RNA"]]@counts,
                               colData=seur.merged2@meta.data[,c("cell_type", "study")])

# sanity check
# table(colnames(seur.merged2@assays[["RNA"]]@counts) == rownames(seur.merged2@meta.data))


# Run metaneighbor
mtn2 <- MetaNeighborUS(var_genes=hvg.union2,
                       dat=count2,
                       study_id=seur.merged2$study,
                       cell_type=seur.merged2$cell_type,
                       one_vs_best = FALSE,
                       fast_version=TRUE)

# checkpoint save
saveRDS(mtn2, "~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/mtn_park.rds")
mtn2 <- readRDS("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/mtn_park.rds")

# Heatmap
jpeg("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/metaneighbor_thymocytesonly_onevsbest.jpeg",
     width=1000, height=1000, res=150)
heatmap.2(mtn2,
          # trace
          trace="none",
          # Rowv=FALSE,
          # Colv=FALSE,
          # superimpose a density histogram on color key
          density.info="none",
          # color scale
          col=rev(colorRampPalette(brewer.pal(11,"RdYlBu"))(100)),
          breaks=seq(0,1,length=101),
          #na.rm=F,
          na.color="grey",
          # text labels
          main="Comparison with Park thymocytes",
          cexRow=0.6,
          cexCol=0.6,
          # margins
          margins=c(7,7))
dev.off()


# Reformat AUROC into df
library(reshape2)
library(ggrepel)
mtn.df <- melt(mtn2)
mtn.df <- mtn.df %>%
  filter(str_detect(Var1,"gapin_data")) %>%
  mutate(Var1 = gsub("gapin_data\\|", "", Var1)) %>%
  filter(str_detect(Var2, "park_data")) %>%
  mutate(Var2 = gsub("park_data\\|", "", Var2))

interesting_clusters <- mtn.df %>%
  group_by(Var1) %>%
  top_n(1, value)

ggplot(mtn.df, aes(x=factor(Var1, level=paste0("c", 0:17)),
                   y=value,
                   color=factor(Var2, level=names(cols_park))))+
  geom_hline(yintercept=0.9, linetype="dashed", color="grey")+
  geom_hline(yintercept=0.5, linetype="dashed", color="grey")+
  geom_point()+
  geom_text_repel(data = interesting_clusters,
                  aes(label = Var2), nudge_y=0.1, show.legend=FALSE)+
  scale_color_manual(values=cols_park, name="Park clusters")+
  ylim(c(0,1.2))+
  labs(x="Gapin clusters", y="AUROC")+
  theme_cowplot()
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/metaneighbor_thymocytesonly_ggplot.jpeg", width=8, height=5)

# Get number of cells per gapin cluster and per park cluster
mtn.df <- mtn.df %>%
  left_join(as.data.frame(table(seur.thymus$cell_type)), by="Var1") %>%
  dplyr::rename(ncells_gapin=Freq) %>%
  left_join(as.data.frame(table(seur.park.thymocytes$cell_type)) %>% dplyr::rename(Var2=Var1), by="Var2") %>%
  dplyr::rename(ncells_park=Freq)

bp.x <- ggplot(data=mtn.df, aes(x=factor(Var1, levels=paste0("c", 0:17)), y=ncells_gapin))+
  geom_bar(stat="identity", fill="#bdbdbd") + theme_cowplot()+
  scale_x_discrete(position="top")+
  labs(y="#cells")+
  theme(#axis.title.y = element_blank(),
    axis.text.y = element_blank(), axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 15), axis.title.x = element_blank(), axis.line.x=element_blank(),
    legend.position = "none") #+
# scale_fill_distiller(name = "Value", palette = "Greys", direction = 1)

# Change order of Park clusters
order_park <- c("DN(early)", "DN(P)", "DN(Q)", "DP(P)", "DP(Q)", "αβT(entry)", "T(agonist)", "CD8αα(I)", "CD8αα(II)",
                "γδT", "Treg(diff)", "Treg", "CD4+T", "CD8+T", "Th17", "NKT")
bp.y <- ggplot(data=mtn.df, aes(x=factor(Var2, levels=rev(order_park)), y=ncells_park))+
  geom_bar(stat="identity", fill="#bdbdbd") +
  scale_x_discrete(position="top") + labs(y="#cells")+ coord_flip() + theme_cowplot()+
  theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size=15), axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        #axis.title.x = element_blank(),
        axis.line.y=element_blank(),
        legend.position = "none")# +
# scale_fill_distiller(name = "Value", palette = "Greys", direction = 1)

# Bubble plot
library(scales)
hm.clean <- ggplot(mtn.df, aes(x=factor(Var1, levels=paste0("c", 0:17)),
                               y=factor(Var2, levels=rev(order_park)), size = value,
                               color=value)) +
  geom_point(alpha=0.7)+
  scale_colour_gradient2(low="#d9d9d9", mid="white", high="#a50f15", midpoint=0.5, limits=c(0,1), name="AUROC")+
  labs(x="",y="Park clusters", size="AUROC")+
  theme_cowplot()+
  theme(legend.position="bottom", legend.key.width = unit(1, 'cm'))
```

```{r, fig.height=8, fig.width=8}
plot_grid(bp.x+theme(plot.margin = margin(b=-5,unit="cm")),
          NULL,
          hm.clean+theme(plot.margin = margin(t=-5, r=-5, unit="cm")),
          bp.y,
          align="hv", axis="tblr",
          ncol=2, nrow=2,
          rel_widths=c(2.5,1), rel_heights=c(1,3))
ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/metaneighbor_bubbleplot3.jpeg", width=12, height=12)

ggdraw()+
  draw_plot(bp.x, x=0.07, y=0.7, width=0.63, height=0.2)+
  draw_plot(bp.y, x=0.7, y=0.07, width=0.2, height=0.63)+
  draw_plot(hm.clean, x=0, y=0, width=0.7, height=0.7)
ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/metaneighbor_bubbleplot2.jpeg", width=12, height=12)
```




### 2.4. Harmony integration
```{r park-harmony-integration}
# last cleanup
# table(seur.park.thymocytes@meta.data[,c("sample_id", "sort")])
# table(seur.park.thymocytes@meta.data[,c("sample_id", "donor_id")])
colnames(seur.park.thymocytes@meta.data)[18] <- "Method"
colnames(seur.park.thymocytes@meta.data)[5] <- "Batch"


# Put everything into one object
seur.merged2 <- merge(seur.thymus, y=seur.park.thymocytes)

# sanity checks
ncol(seur.thymus) + ncol(seur.park.thymocytes) # total nb of samples
length(union(rownames(seur.thymus), rownames(seur.park.thymocytes))) # total nb of genes
print(seur.merged2)

# Check if each seurat object has normalized data
seur.thymus@assays$RNA@counts[5:10,1:5]
seur.thymus@assays$RNA@data[5:10,1:5]

seur.park.thymocytes@assays$RNA@counts[1:5,1:5]
seur.park.thymocytes@assays$RNA@data[1:5,1:5]

# Yes !

# last sanity check
table(seur.merged2$study, useNA="ifany")
table(seur.merged2$Method, useNA="ifany")
table(seur.merged2$Batch, useNA="ifany")


# Do preprocessing
# seur.merged2 <- NormalizeData(seur.merged2)
seur.int <- FindVariableFeatures(seur.merged2, selection.method="vst", nfeatures=5000)
seur.int <- ScaleData(seur.int)
seur.int <- RunPCA(seur.int, npcs=50, verbose=FALSE, approx=FALSE)
seur.int <- RunHarmony(seur.int, reduction = "pca", max.iter.harmony=30,
                       group.by.vars = c("study", "Method", "Batch"))
ElbowPlot(seur.int, ndims=50, reduction="harmony")
DimPlot(seur.int, reduction="pca", group.by="study") | DimPlot(seur.int, reduction="harmony", group.by="study")
DimPlot(seur.int, reduction="pca", group.by="Batch") + theme(legend.position="none") | DimPlot(seur.int, reduction="harmony", group.by="Batch")  + theme(legend.position="none")
DimPlot(seur.int, reduction="pca", group.by="Method") | DimPlot(seur.int, reduction="harmony", group.by="Method")

# UMAP and clustering
seur.int <- RunUMAP(seur.int, reduction = "harmony", dims = 1:10, n.neighbors=50, reduction.key = "UMAP50_")
print("Cluster")
seur.int <- FindNeighbors(seur.int, k.param=20, reduction = "harmony", dims = 1:10)
seur.int <- FindClusters(seur.int, resolution = 0.8, random.seed = 0)

# saveRDS(seur.int, "~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/seurat_integrated_park_23-03-13.rds") # checkpoint save
seur.int <- readRDS("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/seurat_integrated_park_23-03-13.rds")

# Visualization sanity check
DimPlot(seur.int, reduction = "umap", group.by="study", label = F)+
  scale_color_manual(values=c("#d6604d", "#4393c3"))+
  theme(axis.ticks=element_blank(),
        axis.text=element_blank(),
        axis.title=element_text(hjust=0),
        panel.border = element_rect(colour = "black", fill=NA, linewidth=1))
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/integration_harmony_study.jpeg", width=9, height=8)
DimPlot(seur.int, reduction = "umap", group.by="cell_type", label = TRUE, repel = TRUE)
DimPlot(seur.int, reduction = "umap", group.by="seurat_clusters", label = TRUE, repel = TRUE)
```

```{r park-harmony-integration-visualize, fig.width=15, fig.height=10}
# See cell type composition per cluster
df <- seur.int@meta.data %>%
  as_tibble() %>%
  group_by(cell_type, seurat_clusters, study) %>%
  summarize(ncells=n())
ggplot(df, aes(x=seurat_clusters, y=ncells, fill=cell_type)) +
  geom_bar(stat="identity", position="fill")


# Plot cell types
cols_integrated <- c("c0" = "#f4c40f",
                     "c1" = "#b75347",
                     "c2" = "#d8443c",
                     "c3" = "#e09351",
                     "c4" = "#2b9b81", 
                     "c5" = "#421401",
                     "c6" = "#92c051",
                     "c7" = "#9f5691",
                     "c8" = "#17154f",
                     "c9" = "#74c8c3", 
                     "c10" = "#5a97c1",
                     "c11" = "gold",
                     "c12" = "#a40000",
                     "c13" = "#72bcd5",
                     "c14" = "grey50",
                     "c15" = "orange",
                     "c16" = "blueviolet",
                     "c17" = "#0a2e57",
                     "c18" = "#bdbdbd",
                     "CD4+T"= "gold",
                     "CD8+T"= "#5a97c1",
                     "CD8αα(I)" = "#421401",
                     "CD8αα(II)" = "#0a2e57",
                     "DN(early)" = "#78c679",
                     "DN(P)" = "#41ab5d",
                     "DN(Q)" = "#238443",
                     "DP(P)" = "#b75347",
                     "DP(Q)" = "#d8443c",
                     "NKT" = "#72bcd5",
                     "T(agonist)" = "#9f5691",
                     "Th17" = "#a40000",
                     "Treg" = "blueviolet",
                     "Treg(diff)" = "#6a51a3",
                     "αβT(entry)" = "#e09351",
                     "γδT" = "#92c051")

DimPlot(seur.int, reduction = "umap", group.by="cell_type", split.by="study", label = TRUE, repel = TRUE, raster=FALSE)+
  scale_color_manual(values=cols_integrated)
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/integration_harmony.jpeg", width=20, height=8)


# Split cell names by cell_type (in list)
Idents(seur.int) <- "cell_type"
cells.list <- setNames(names(Idents(seur.int)), Idents(seur.int))
cells.list <- split(cells.list, names(cells.list))
cells.list <- lapply(cells.list, unname)

# Function for plotting
plotUMAP <- function(seurobj=seur.int, cells_of_interest){
  # Get the colors for clusters of interest, and reorder it in alphabetical order
  colors_of_interest <- cols_integrated[names(cols_integrated) %in% cells_of_interest]
  order <- rev(names(colors_of_interest)[order(names(colors_of_interest))]) # alphabetical order
  colors_of_interest <- colors_of_interest[order]
  
  # Create color vector
  # colors_of_interest <- brewer.pal(length(cells_of_interest), "Paired")
  # names(colors_of_interest) <- cells_of_interest
  
  # Plot
  p <- DimPlot(seurobj,
               reduction = "umap",
               group.by="cell_type",
               # split.by="study",
               label = FALSE,
               repel = FALSE,
               raster=FALSE,
               cells.highlight=cells.list[names(cells.list) %in% cells_of_interest],
               sizes.highlight = 0.5,
               cols.highlight=colors_of_interest,
               cols="#d9d9d9")+
    theme_cowplot()+
    labs(title="")+
    theme(axis.text = element_blank(),
          axis.ticks= element_blank(),
          axis.title=element_text(hjust=0))
  
  return(p)
}

names(cells.list)
# split by groups of interest
plotUMAP(cells_of_interest=c("c0", "c1", "c2", "DN(early)", "DN(P)", "DN(Q)", "DP(P)", "DP(Q)"))
plotUMAP(cells_of_interest=c("c3", "c11", "αβT(entry)", "CD4+T"))
plotUMAP(cells_of_interest=c("c4", "αβT(entry)", "T(agonist)"))
plotUMAP(cells_of_interest=c("c5", "CD8αα(I)", "CD8αα(II)"))
plotUMAP(cells_of_interest=c("c6", "γδT", "DN(early)"))
plotUMAP(cells_of_interest=c("c7", "Treg", "Treg(diff)", "T(agonist)"))
plotUMAP(cells_of_interest=c("c8", "CD4+T", "Treg", "Treg(diff)", "T(agonist)", "Th17"))
plotUMAP(cells_of_interest=c("c9", "c10", "αβT(entry)", "CD8+T", "DP(Q)"))
plotUMAP(cells_of_interest=c("c12", "c13", "c14", "c15", "c16", "c17", "NKT", "Treg", "Th17"))


# loop through cluster by cluster
clusters_order <- c("DN(early)", "DN(P)", "DN(Q)", "DP(P)", "DP(Q)",
                    "c0", "c1", "c2", "c3", "c9",
                    "αβT(entry)", "CD8αα(I)", "CD8αα(II)", "γδT", "T(agonist)",
                    "c4", "c5", "c6", "c7", "c8",
                    "CD4+T", "CD8+T", "c10", "c11",
                    "NKT", "Treg", "Treg(diff)", "Th17",
                    "c12", "c13", "c14", "c15", "c16", "c17")

plist <- list()

for(cellgroup in clusters_order){
  print(cellgroup)
  plist[[cellgroup]] <- plotUMAP(cells_of_interest=cellgroup)
}


```



### 2.5. Integration of full Park dataset with our dataset
#### 2.5.1. Import data
```{r fullpark-gapin-integration1}
## GAPIN DATA ####
# Import our seurat object (low quality cells removed)
seur <- readRDS("data/raw_data/human_data/seurat_filtered_harmony_02_15_23.RDS")

print(seur) # 78,607 cells
cols_integrated <- c("0" = "#f4c40f", "1" = "#b75347", "2" = "#d8443c",
                     "3" = "#e09351", "4" = "#2b9b81", "5" = "#421401",
                     "6" = "#92c051", "7" = "#9f5691", "8" = "#17154f",
                     "9" = "#74c8c3", "10" = "#5a97c1", "11" = "gold", 
                     "12" = "#a40000", "13" = "#72bcd5", "14" = "grey50",
                     "15" = "orange", "16" = "blueviolet", "17" = "#0a2e57",
                     "18" = "#bdbdbd")
SCpubr::do_DimPlot(seur, 
                   group.by = "new_clusters",
                   label=TRUE,
                   label.color="black",
                   legend.position = "none",
                   repel=TRUE,
                   colors.use=cols_integrated,
                   font.size = 24)

basedir <- "~/Projects/HumanThymusProject"
#intdir <- file.path(basedir, "data/human-thymus/HumanData_16_ParkIntegration")
intdir <- "data/human-thymus/HumanData_16_ParkIntegration"

## PARK DATA ####
seur.park <- readRDS(file.path(intdir, "park_full_seu_gene_names.rds"))

# Add better cell_type to full park seurat object
park_metadata <- read.csv(file.path(intdir, "park_fullmetadata.csv"))


# Whole data annotation
seur.park2 <- seur.park
table(park_metadata$index == rownames(seur.park2@meta.data)) # yessss nice
annotation_columns <- colnames(park_metadata)[2:7]
seur.park2@meta.data[,annotation_columns] <- park_metadata[,annotation_columns]
# table(seur.park2@meta.data[,c("cell_type", "Anno_level_1")]) # sanity check
seur.park2@meta.data$cell_type <- NULL
```

#### 2.5.2. Prepare data
```{r fullpark-gapin-integration2}
## KEEP ONLY COMMON GENES TO 2 DATASETS ####
# check out overlap gene names between Park data and our data
ggVennDiagram(
  x=list(rownames(seur), rownames(seur.park2)),
  category.names = c("Gapin" , "Park"),
  label_alpha=0,
  label="count"
) +
  ggplot2::scale_fill_gradient(low="white",high = "blue")

# keep only genes common to the 2 datasets
common_genes <- intersect(rownames(seur), rownames(seur.park2))
length(common_genes) # 13,988 genes
seur.gapin <- seur[common_genes,]
seur.park2 <- seur.park2[common_genes,]

## KEEP ONLY RELEVANT METADATA COLUMNS ####
# Gapin data
gapin_columns_to_keep <- colnames(seur.gapin@meta.data)[1:32]
gapin_columns_to_keep <- gapin_columns_to_keep[!gapin_columns_to_keep %in% c("seurat_clusters", "RNA_snn_res.0.7", "RNA_snn_res.1.2")]
seur.gapin@meta.data <- seur.gapin@meta.data[,gapin_columns_to_keep]
colnames(seur.gapin@meta.data)[6] <- "sex"
colnames(seur.gapin@meta.data)[8] <- "donor_id"
colnames(seur.gapin@meta.data)[11] <- "tissue"
colnames(seur.gapin@meta.data)[14] <- "cell_clusters"
seur.gapin@meta.data[,"cell_clusters"] <- paste0("c",seur.gapin@meta.data[,"cell_clusters"])
seur.gapin@meta.data$study <- "gapin_data"

# Park data
colnames(seur.park2@meta.data)[13] <- "Batch"
colnames(seur.park2@meta.data)[20] <- "percent.mt"
seur.park2@meta.data$tissue <- "Thymus"
seur.park2@meta.data$study <- "park_data"
# table(seur.park2@meta.data$tissue, useNA="ifany")
# table(seur.park2@meta.data$Batch, useNA="ifany")


## GET RAW COUNTS ####
# counts.gapin <- seur.gapin@assays[["RNA"]]@counts
# metadf.gapin <- seur.gapin@meta.data
# counts.park  <- seur.park2@assays[["RNA"]]@counts
# metadf.park  <- seur.park2@meta.data


## ADD DIFFERENT LEVELS OF CELL ANNOTATION TO GAPIN DATA ####
# DimPlot(seur.park2, group.by = "Anno_level_1", label=TRUE)
# DimPlot(seur.park2, group.by = "Anno_level_2", label=TRUE)
# DimPlot(seur.park2, group.by = "Anno_level_3", label=TRUE)
# DimPlot(seur.park2, group.by = "Anno_level_5", label=TRUE)

seur.gapin@meta.data$Anno_level_1 <- case_when(
  seur.gapin@meta.data$cell.ident %in% c("NKT", "MAIT", "GD") ~ "Innate_T",
  seur.gapin@meta.data$cell.ident %in% c("CD4", "CD8") ~ "T",
)
# table(seur.gapin@meta.data[,c("cell.ident", "Anno_level_1")], useNA="ifany")
# seur.gapin@meta.data$Anno_level_2 <- case_when(
#   seur.gapin@meta.data$tissue=="PBMC" ~ "Periph_T",
#   seur.gapin@meta.data$tissue=="Thymus" & seur.gapin@meta.data$cell_clusters %in% c("c0", "c1") ~ "DN",
#   seur.gapin@meta.data$tissue=="Thymus" & seur.gapin@meta.data$cell_clusters %in% c("c2") ~ "DP",
#   seur.gapin@meta.data$tissue=="Thymus" & seur.gapin@meta.data$cell_clusters %in% paste0("c", 3:17) & seur.gapin@meta.data$cell.ident %in% c("NKT", "MAIT", "GD") ~ "Innate_T",
#   seur.gapin@meta.data$tissue=="Thymus" & seur.gapin@meta.data$cell_clusters %in% paste0("c", 3:17) & seur.gapin@meta.data$cell.ident %in% c("CD4", "CD8") ~ "SP"
# )
# table(seur.gapin@meta.data[,c("tissue", "Anno_level_2")], useNA="ifany")
seur.gapin@meta.data$Anno_level_3 <- case_when(
  seur.gapin@meta.data$tissue=="PBMC"   &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 0:11) ~ "pbmc_T_naive",
  seur.gapin@meta.data$tissue=="PBMC"   &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 12:17) ~ "pbmc_T_memory",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c0", "c1") ~ "DN",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c2") ~ "DP",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 3:17) &
    seur.gapin@meta.data$cell.ident == "GD" ~ "γδT",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c3", "c11", "c9", "c10") &
    seur.gapin@meta.data$cell.ident != "GD" ~ "T_naive",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c4" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "T(agonist)",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c5" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "CD8αα(I)",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c6" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "CD8αα(II)",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c7" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "Treg",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c8" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "T_IFNsignaling",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 12:17) &
    seur.gapin@meta.data$cell.ident != "GD" ~ "Teffector",
)

seur.gapin@meta.data$Anno_level_5 <- case_when(
  # PBMC
  seur.gapin@meta.data$tissue=="PBMC"   &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 0:11)  ~ "pbmc_T_naive",
  seur.gapin@meta.data$tissue=="PBMC"   &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 12:17) ~ "pbmc_T_memory",
  # THYMUS
  # THYMUS - DN
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c0" ~ "DN(Q)",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c1" ~ "DN(P)",
  # THYMUS - DP
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c2" ~ "DP",
  # THYMUS - γδ
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 3:17) &
    seur.gapin@meta.data$cell.ident == "GD" ~ "γδT",
  # THYMUS - T naive
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c3", "c9") &
    seur.gapin@meta.data$cell.ident %in% c("CD4", "CD8") ~ "αβT(entry)",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c11", "c10") &
    seur.gapin@meta.data$cell.ident == "CD4" ~ "CD4+T",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c11", "c10") &
    seur.gapin@meta.data$cell.ident == "CD8" ~ "CD8+T",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c3", "c9","c11", "c10") &
    seur.gapin@meta.data$cell.ident == "NKT" ~ "iNKT_naive",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% c("c3", "c9","c11", "c10") &
    seur.gapin@meta.data$cell.ident == "MAIT" ~ "MAIT_naive",
  # THYMUS - Tagnonist
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c4" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "T(agonist)",
  # THYMUS - CD8aa
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c5" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "CD8αα(I)",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c6" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "CD8αα(II)",
  # THYMUS - Treg
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c7" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "Treg",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c8" &
    seur.gapin@meta.data$cell.ident != "GD" ~ "T_IFNsignaling",
  # THYMUS - effector
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 12:17) &
    seur.gapin@meta.data$cell.ident == "CD4" ~ "CD4+T_effector",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 12:17) &
    seur.gapin@meta.data$cell.ident == "CD8" ~ "CD8+T_effector",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters == "c12" &
    seur.gapin@meta.data$cell.ident == "NKT" ~ "iNKT_effector_Tcm",
  seur.gapin@meta.data$tissue=="Thymus" &
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 13:17) &
    seur.gapin@meta.data$cell.ident == "NKT" ~ "iNKT_effector_Tem",
  seur.gapin@meta.data$tissue=="Thymus" & 
    seur.gapin@meta.data$cell_clusters %in% paste0("c", 12:17) &
    seur.gapin@meta.data$cell.ident == "MAIT" ~ "MAIT_effector_Tem",
)
# table(seur.gapin@meta.data[,c("Anno_level_5", "Anno_level_3")], useNA="ifany")
```

#### 2.5.3. Integrate data
```{r fullpark-gapin-integration3, fig.height=10, fig.width=10}
## MAKE SEURAT OBJECT
seur.combined <- merge(seur.gapin, seur.park2)

# Sanity checks
sum(ncol(seur.gapin), ncol(seur.park2)) # sanity check number of cells
seur.gapin@assays[["RNA"]]@data[5:10,1:5]
seur.combined@assays[["RNA"]]@data[5:10,1:5]
seur.park2@assays[["RNA"]]@data[5:10,1:5]
seur.combined@assays[["RNA"]]@data[5:10,78608:78613] # same data counts
table(seur.combined@meta.data$tissue, useNA="ifany")
table(seur.combined@meta.data$study, useNA="ifany")
table(seur.combined@meta.data$cell_clusters, useNA="ifany")
table(seur.combined@meta.data$Batch, useNA="ifany")
table(seur.combined@meta.data$Anno_level_1, useNA="ifany")
table(seur.combined@meta.data$Anno_level_3, useNA="ifany")
table(seur.combined@meta.data$Anno_level_5, useNA="ifany")

# Save seurat object
# saveRDS(seur.combined, "~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/seurat_integrated_fullpark_fullgapin_23-05-02.rds")


# ## NORMALIZE
# seur.list <- SplitObject(seur.combined, split.by = "Batch")
# 
# seur.list <- lapply(X = seur.list, FUN = function(x) {
#     x <- NormalizeData(x)
#     x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000)
# })
# features <- SelectIntegrationFeatures(object.list = seur.list, nfeatures=2000)
# 
# 
# ## INTEGRATE
# anchors <- FindIntegrationAnchors(object.list = seur.list, anchor.features = features)
# seur.integrated <- IntegrateData(anchorset = anchors)
# 
# 
# ## INTEGRATED ANALYSIS
# seur.integrated <- ScaleData(seur.integrated, verbose = FALSE)
# seur.integrated <- RunPCA(seur.integrated, npcs = 50, verbose = FALSE)
# seur.integrated <- RunUMAP(seur.integrated, reduction = "pca", dims = 1:30)


## VISUALIZE
# DimPlot(seur.integrated, reduction = "umap", group.by = "study")
```

#### 2.5.4. Get markers
First at high level:
- DP
- cTEC
- mTEC
- iNKT
- MAIT

```{r fullpark-gapin-integration4, fig.height=10, fig.width=10}
## PARK MARKERS
# Markers bigger categories
#seur.park2 <- subset(seur.combined, subset=study=="park_data")

min.pct <- 0.3
logfc.thr = 0.3

Idents(seur.park2) <- "Anno_level_3"
markers.dp <- FindMarkers(seur.park2, ident.1="DP", min.pct=min.pct,
                          logfc.threshold = logfc.thr, only.pos=T)
markers.dp %>% arrange(-avg_log2FC)

markers.ctec <- FindMarkers(seur.park2, ident.1="cTEC", min.pct=min.pct,
                            logfc.threshold = logfc.thr, only.pos=T)
markers.ctec %>% arrange(-avg_log2FC)

markers.mtec <- FindMarkers(seur.park2, ident.1="mTEC", min.pct=min.pct,
                            logfc.threshold = logfc.thr, only.pos=T)
markers.mtec %>% arrange(-avg_log2FC)

DimPlot(seur.park2, group.by = "Anno_level_5", label=TRUE)
VlnPlot(seur.park2, group.by = "Anno_level_3", features=c("MR1"), raster=F)


## GAPIN MARKERS
Idents(seur.gapin) <- "Anno_level_5"
markers.nkt_naive <- FindMarkers(seur.gapin, ident.1="iNKT_naive",
                                 min.pct=min.pct,
                                 logfc.threshold = logfc.thr, only.pos=T)
markers.nkt_naive %>% arrange(-avg_log2FC)

markers.nkt_effectorTcm <- FindMarkers(seur.gapin, ident.1="iNKT_effector_Tcm",
                                       min.pct=min.pct,
                                       logfc.threshold = logfc.thr,
                                       only.pos=T)
markers.nkt_effectorTcm %>% arrange(-avg_log2FC)

markers.nkt_effectorTem <- FindMarkers(seur.gapin, ident.1="iNKT_effector_Tem", 
                                       min.pct=min.pct,
                                       logfc.threshold = logfc.thr,
                                       only.pos=T)
markers.nkt_effectorTem %>% arrange(-avg_log2FC)

markers.mait_naive <- FindMarkers(seur.gapin, ident.1="MAIT_naive",
                                  min.pct=min.pct, 
                                  logfc.threshold = logfc.thr,
                                  only.pos=T)
markers.mait_naive %>% arrange(-avg_log2FC)

markers.mait_effectorTem <- FindMarkers(seur.gapin, ident.1="MAIT_effector_Tem", 
                                        min.pct=min.pct,
                                        logfc.threshold = logfc.thr, 
                                        only.pos=T)
markers.mait_effectorTem %>% arrange(-avg_log2FC)

DimPlot(seur.gapin, reduction="UMAP_50", group.by = "Anno_level_3", label=T)

format_markers <- function(markerlist, nr_marker=50) {
  tmp <- markerlist %>% 
    arrange(-avg_log2FC) %>% 
    head(nr_marker) %>% 
    rownames_to_column("genes") %>% 
    pull(genes)
  if (length(tmp) < nr_marker) {
    tmp <- c(tmp, rep(NA, nr_marker-length(tmp)))
  }
  return(tmp)
}

## JOIN INTO ONE TABLE
final_markers <- data.frame(
  "DP"               = format_markers(markers.dp) ,
  "cTEC"             = format_markers(markers.ctec) ,
  "mTEC"             = format_markers(markers.mtec) ,
  "NKT_naive"        = format_markers(markers.nkt_naive),
  "NKT_effectorTcm"  = format_markers(markers.nkt_effectorTcm),
  "NKT_effectorTem"  = format_markers(markers.nkt_effectorTem),
  "MAIT_naive"       = format_markers(markers.mait_naive),
  "MAIT_effectorTem" = format_markers(markers.mait_effectorTem)
)
# write.csv2(final_markers, "~/Projects/HumanThymusProject/data/human-thymus/HumanData_16_ParkIntegration/cellphonedb_markers.csv")

markers.dp %>%
  rownames_to_column("genes") %>%
  filter(genes=="CD1D")
```

