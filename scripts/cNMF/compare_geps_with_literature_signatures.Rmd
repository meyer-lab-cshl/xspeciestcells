---
title: "Supplementary Fig 10 - Compare GEPs with literature gene signatures"
author: "Salom√© Carcy"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true

---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 5,
  fig.height = 5,
  warning = FALSE,
  message = FALSE,
  root.dir = "~/Projects/HumanThymusProject/"
)
```




# IMPORT

## Import librairies
```{r import-librairies}
library(Seurat)
library(cowplot)
library(ggplot2)
library(tidyverse)
library(tidytext)
library(pheatmap)

setwd("~/Projects/HumanThymusProject/")
source("~/Projects/HumanThymusProject/scripts/colors_universal.R")
```


## Import data
The list of genes characterizing each GEP was determined based on the gene ranks associated to each GEP (see Methods details & Supplementary Fig 17).
```{r import-data}
# genes characterizing each GEP
genes.gep <- read.csv("./data_github/cNMF/limited_nonimputed_genes_per_gep_post_rank_threshold_k12.csv", row.names=1)

# literature-derived gene signatures
genes.cano    <- readxl::read_excel("./data_github/literature_gene_signatures/canogamez_supptable.xlsx", skip=3, sheet=1)
genesCD8.rose <- readxl::read_excel("./data_github/literature_gene_signatures/rose_supp_clusmodulesCD8.xlsx", sheet=1)
genesCD4.rose <- readxl::read_excel("./data_github/literature_gene_signatures/rose_supp_clusmodulesCD4.xlsx", sheet=1)
genes.poon    <- readxl::read_excel("./data_github/literature_gene_signatures/poon_supptable.xlsx", sheet=6)[,-1]
genes.terekhova_general <- readxl::read_excel("./data_github/literature_gene_signatures/terekhova_supptable.xlsx", sheet=1)
genes.terekhova_cd4 <- readxl::read_excel("./data_github/literature_gene_signatures/terekhova_supptable.xlsx", sheet=3)
genes.terekhova_cd8 <- readxl::read_excel("./data_github/literature_gene_signatures/terekhova_supptable.xlsx", sheet=5)
genes.terekhova_gdt <- readxl::read_excel("./data_github/literature_gene_signatures/terekhova_supptable.xlsx", sheet=7)

# seurat object
seur_integrated <- readRDS("./data_geo/seurat_objects/seurat_human_integrated_object_23_12_01.rds")
seur.pbmc <- subset(seur_integrated, tissue=="PBMC")
DimPlot(seur.pbmc, reduction="umap_integrated", group.by="clusters_integrated_data", cols=cols_integrated)
```




# FUNCTIONS
```{r define-functions}

```




# 1. PREPARE GENE LISTS

We will store all gene lists dataframes (genes for each GEP, genes for each literature-derived gene signature) in a list, which we will eventually combine into a single long-format dataframe.
```{r set-genesig-list}
genesig_longdf_list <- list()
```


## 1.1. GEPs
```{r prep-geps}
head(genes.gep)
geps_df <- gather(genes.gep, key=geneprogram, value=gene, colnames(genes.gep)) %>%
  filter(!is.na(gene)) %>%
  mutate(geneprogram=sub("_", "", geneprogram))
head(geps_df)

# check nb of genes per GEP
table(geps_df$geneprogram, useNA="ifany")

# add df to genesig_longdf_list
genesig_longdf_list[["GEPs"]] <- geps_df

# sanity check
# table(is.na(genesig_longdf_list$GEPs$gene)) # all FALSE
```


## 1.2. Cano-Gamez _et al._ gene signatures
```{r prep-canogamez}
head(genes.cano)

# take a look at the different clusters/gene programs available
table(genes.cano$cluster, useNA="ifany")

# get a long format df with gene signatures
cano_df <- genes.cano %>%
  mutate(
    cluster=gsub(" ", "", cluster),
    cluster=paste0("CanoGamez | CD4_", cluster)
  ) %>%
  # keep only significant genes & with minimum log2FC
  filter(p_val_adj < 0.05 & LFC > 0.25) %>% # lowest log2FC is 0.25
  # keep only columns of interest
  select(cluster, gene) %>%
  rename(geneprogram=cluster) %>%
  # add general categories
  mutate(geneprogram_cat=case_when(
    geneprogram=="CanoGamez | CD4_Tnaive" ~"Tnaive",
    geneprogram=="CanoGamez | CD4_TCM"    ~"Tcm",
    geneprogram=="CanoGamez | CD4_TEM"    ~"Tem",
    geneprogram=="CanoGamez | CD4_TEMRA"  ~"Temra",
    geneprogram=="CanoGamez | CD4_nTreg"  ~"Treg"
  ))
head(cano_df)

# add df to genesig_longdf_list
genesig_longdf_list[["canogamez"]] <- cano_df

# table(is.na(genesig_longdf_list$canogamez$gene)) # sanity check
```


## 1.3. Rose _et al._ gene signatures
Let's first do a little sanity check that we are able to reproduce the heatmaps in [Figures 2e and 2h](https://www.nature.com/articles/s42003-023-04747-9/figures/2) of the Rose _et al._ paper.
```{r rose-reproduce-htmps, fig.height=6, fig.width=4}
htmp <- function(rosedf, lineage){
  # Get rpkm
  if(lineage=="CD4"){ counts <- rosedf[,9:20] }
  else if(lineage=="CD8"){ counts <- rosedf[,9:24] }
  counts <- as.data.frame(counts)
  rownames(counts) <- rosedf$ENTREZID
  # Get metadata
  meta <- rosedf[,c(1,3)] %>% column_to_rownames("ENTREZID")
  cols <- RColorBrewer::brewer.pal(5, "Greys")
  names(cols) <- unique(meta$k.5.cluster)
  # Plot
  pheatmap(counts,
           scale="row",
           cluster_rows=F,
           cluster_cols=F,
           color=rev(colorRampPalette(RColorBrewer::brewer.pal(10, "RdBu"))(100)),
           annotation_row=meta,
           annotation_colors=list(k.5.cluster=cols),
           show_rownames=F)
}

htmp(genesCD4.rose, lineage="CD4")
htmp(genesCD8.rose, lineage="CD8")
```

These plots indeed resemble Figures 2e & h from the original paper. Let's obtain the gene signatures then.
```{r prep-rose}
head(genesCD4.rose)
head(genesCD8.rose)

roseCD4 <- genesCD4.rose %>%
  select(SYMBOL, k.5.cluster) %>%
  filter(!is.na(SYMBOL)) %>% # the few NA symbols are miRNA or uncharacterized loci
  rename(gene=SYMBOL, geneprogram=k.5.cluster) %>%
  mutate(
    geneprogram=ifelse(geneprogram==1, "Rose | CD4_modul1_Tem/cm",
                       ifelse(geneprogram==2, "Rose | CD4_modul2_Tcm/em",
                              ifelse(geneprogram==3, "Rose | CD4_modul3_Tem/cm",
                                     ifelse(geneprogram==4, "Rose | CD4_modul4_Tem",
                                            ifelse(geneprogram==5, "Rose | CD4_modul5_Tnaive", "?")))))
  )

roseCD8 <- genesCD8.rose %>%
  select(SYMBOL, k.5.cluster) %>%
  filter(!is.na(SYMBOL)) %>% # the few NA symbols are miRNA or uncharacterized loci
  rename(gene=SYMBOL, geneprogram=k.5.cluster) %>%
  mutate(
    geneprogram=ifelse(geneprogram==1, "Rose | CD8_modul1_Temra",
                       ifelse(geneprogram==2, "Rose | CD8_modul2_Tcm/em",
                              ifelse(geneprogram==3, "Rose | CD8_modul3_Tem/emra",
                                     ifelse(geneprogram==4, "Rose | CD8_modul4_Tnaive",
                                            ifelse(geneprogram==5, "Rose | CD8_modul5_Tnaive/cm", "?")))))
  )

rose_df <- rbind(roseCD4, roseCD8) %>%
  mutate(geneprogram_cat=case_when(
    geneprogram=="Rose | CD4_modul1_Tem/cm"    ~ "Tem",
    geneprogram=="Rose | CD4_modul2_Tcm/em"    ~ "Tcm",
    geneprogram=="Rose | CD4_modul3_Tem/cm"    ~ "Tem",
    geneprogram=="Rose | CD4_modul4_Tem"       ~ "Tem",
    geneprogram=="Rose | CD4_modul5_Tnaive"    ~ "Tnaive",
    geneprogram=="Rose | CD8_modul1_Temra"     ~ "Temra",
    geneprogram=="Rose | CD8_modul2_Tcm/em"    ~ "Tcm",
    geneprogram=="Rose | CD8_modul3_Tem/emra"  ~ "Tem",
    geneprogram=="Rose | CD8_modul4_Tnaive"    ~ "Tnaive",
    geneprogram=="Rose | CD8_modul5_Tnaive/cm" ~ "Tnaive"
  ))
head(rose_df)

# add df to genesig_longdf_list
genesig_longdf_list[["rose"]] <- rose_df

# table(is.na(genesig_longdf_list$rose$gene)) # sanity check
```


## 1.4. Poon _et al._ gene signatures
```{r prep-poon}
head(genes.poon)
colnames(genes.poon) <- gsub(" ", "", colnames(genes.poon))

# Transform to long format gene program by gene program (each gene program has 3 columns: genes symbols, padj, logFC)
poon_df <- data.frame()
for (i in seq(1,ncol(genes.poon), 3)){
  subdf <- genes.poon[,i:(i+2)]
  geneprogram <- sub("_.*", "",colnames(subdf)[1])
  colnames(subdf) <- c("gene", "padj", "logFC")
  subdf <- subdf %>%
    # OPTION 1: full list of Poon genes
    # filter(padj<0.01 & logFC>0.25)
    filter(padj<0.001 & logFC>0.25)
  cat(geneprogram, "\n")
  cat("# genes:", nrow(subdf), "\n")
  cat("min log2FC:", min(subdf$logFC), "\n\n")
  subdf$geneprogram <- paste0("Poon | ", geneprogram) # add column with the name of the geneprogram
  poon_df <- rbind(poon_df, subdf)
}
head(poon_df)
table(poon_df$geneprogram, useNA="ifany")

poon_df <- poon_df %>%
  select(geneprogram, gene) %>%
  mutate(geneprogram_cat=case_when(
    geneprogram=="Poon | CyclingTRM"  ~"Trm",
    geneprogram=="Poon | CD4Naive"    ~"Tnaive",
    geneprogram=="Poon | CD4TCM/TFH"  ~"Tcm",
    geneprogram=="Poon | CD4TRM"      ~"Trm",
    geneprogram=="Poon | CD4Treg"     ~"Treg",
    geneprogram=="Poon | CD8MAIT"     ~"MAIT",
    geneprogram=="Poon | CD8Naive"    ~"Tnaive",
    geneprogram=="Poon | CD8TEM/TEMRA"~"Temra",
    geneprogram=="Poon | CD8TRM"      ~"Trm"
  ))

# add df to genesig_longdf_list
genesig_longdf_list[["poon"]] <- poon_df

# table(is.na(genesig_longdf_list$poon$gene)) # sanity check
```

## 1.5. Terekhova _et al._ gene signatures
In this dataset, the annotation "Tnaive/cm/em/emra" was evaluated based on the heatmaps provided in the paper (looking at CCR7, CD62L, CD45RA, CD45RO).
```{r prep-terekhova}
head(genes.terekhova_general)
# head(genes.terekhova_cd4)
# head(genes.terekhova_cd8)
# head(genes.terekhova_gdt)

terekhova_df <- cbind(
  genes.terekhova_general[,"MAITcells"],
  genes.terekhova_cd4,
  genes.terekhova_cd8,
  genes.terekhova_gdt
  ) %>%
  pivot_longer(cols=everything(), names_to="geneprogram", values_to = "gene") %>%
  mutate(geneprogram=paste0("Terekhova | ", geneprogram),
         geneprogram_cat=case_when(
           geneprogram=="Terekhova | MAITcells"                ~ "MAIT",
           geneprogram=="Terekhova | CD4_Tnaive"               ~ "Tnaive",
           geneprogram=="Terekhova | CD4_Tnaive_IFN"           ~ "Tnaive",
           geneprogram=="Terekhova | CD4_Tfh"                  ~ "Tcm",
           geneprogram=="Terekhova | CD4_Th1"                  ~ "Tcm",
           geneprogram=="Terekhova | CD4_Th1/Th17"             ~ "Tem",
           geneprogram=="Terekhova | CD4_Th17"                 ~ "Tem",
           geneprogram=="Terekhova | CD4_Th22"                 ~ "Tem",
           geneprogram=="Terekhova | CD4_Th2"                  ~ "Tcm",
           geneprogram=="Terekhova | CD4_HLADRpos_memory"      ~ "Tem",
           geneprogram=="Terekhova | CD4_Exhausted-like_memory"~ "Tcm",
           geneprogram=="Terekhova | CD4_Terminal_effector"    ~ "Temra",
           geneprogram=="Terekhova | CD4_Temra"                ~ "Temra",
           geneprogram=="Terekhova | CD4_Treg_cytotoxic"       ~ "Treg",
           geneprogram=="Terekhova | CD4_Treg_naive"           ~ "Treg",
           geneprogram=="Terekhova | CD4_Treg_memory"          ~ "Treg",
           geneprogram=="Terekhova | CD4_Treg_KLRB1+_RORC+"    ~ "Treg",
           geneprogram=="Terekhova | CD8_Tnaive"        ~ "Tnaive",
           geneprogram=="Terekhova | CD8_Tnaive_IFN"    ~ "Tnaive",
           geneprogram=="Terekhova | CD8_Tcm_CCR4pos"   ~ "Tcm",
           geneprogram=="Terekhova | CD8_Tcm_CCR4neg"   ~ "Tcm",
           geneprogram=="Terekhova | CD8_Trm"           ~ "Trm",
           geneprogram=="Terekhova | CD8_Tmem_KLRC2pos" ~ "other",
           geneprogram=="Terekhova | CD8_Tem_GZMKpos"   ~ "Tem",
           geneprogram=="Terekhova | CD8_HLADRpos"      ~ "Tem",
           geneprogram=="Terekhova | CD8_proliferative" ~ "Tprolif",
           geneprogram=="Terekhova | CD8_Tem_GZMBpos"   ~ "Temra",
           geneprogram=="Terekhova | CD8_Temra"         ~ "Temra",
           geneprogram=="Terekhova | CD8_NKTlike"       ~ "Temra",
           geneprogram=="Terekhova | GD_naive"     ~ "Tnaive",
           geneprogram=="Terekhova | GD_Vd2_GZMK+" ~ "Tem",
           geneprogram=="Terekhova | GD_Vd2_GZMB+" ~ "Temra",
           geneprogram=="Terekhova | GD_Vd1_GZMK+" ~ "Tem",
           geneprogram=="Terekhova | GD_Vd1_GZMB+" ~ "Temra"
         ))

# add df to genesig_longdf_list
genesig_longdf_list[["terekhova"]] <- terekhova_df

# table(is.na(genesig_longdf_list$terekhova$gene)) # sanity check
```


## 1.6. Combine gene lists
```{r prep-gene-lists-into-one-df}
longdf <- bind_rows(genesig_longdf_list, .id="dataset")
table(longdf$dataset, useNA="ifany")
# canogamez     gapin      poon      rose   terekhova
#   387         4,068    26,463     1,672       3,400

# remove any genes that we don't have in seur.pbmc (i.e. we didn't detect in our dataset)
longdf <- longdf %>%
  filter(gene %in% rownames(seur.pbmc)) %>%
  filter(geneprogram != "GEP12") # remove batch-driven GEP
table(longdf$dataset, useNA="ifany")
# canogamez     gapin      poon      rose  terekhova
#   341         3,787    19,959     1,542      3,145

# check out the number of genes per signature/program
table(longdf$geneprogram)

# show the longdf
print(longdf)
```

For later use, define colors for each category of gene programs (Tnaive, cm, etc.).
```{r prep-cols-vector}
# Create a colors vector & dataframe
cols_df <- longdf %>%
  select(geneprogram, geneprogram_cat) %>%
  distinct() %>%
  filter(!geneprogram %in% grep("GEP", unique(longdf$geneprogram), value=T)) %>%
  mutate(color= case_when(
    geneprogram_cat=="Tnaive"   ~ "#b3e2cd",
    geneprogram_cat=="Tcm"      ~ "#f4cae4",
    geneprogram_cat=="Tem"      ~ "#cbd5e8",
    geneprogram_cat=="Temra"    ~ "#fdcdac",
    geneprogram_cat=="Treg"     ~ "#fbb4ae",
    geneprogram_cat=="Trm"      ~ "#4292c6",
    geneprogram_cat=="MAIT" ~ "#8c6bb1",
    geneprogram_cat=="Tprolif"  ~ "#e5d8bd",
    geneprogram_cat=="other"     ~ "#f2f2f2",
  ))
cols_geneprogcat <- unique(cols_df$color)
names(cols_geneprogcat) <- unique(cols_df$geneprogram_cat)
```




# 2. COMPUTE OVERLAP BETWEEN GENE LISTS (Sup Fig 10A)

## 2.1. Define Jaccard function
```{r function-jaccard}
overlapcoef <- function(a, b, coef="jaccardweight") {
  # Jaccard Index
  if(coef=="jaccard"){
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    return (intersection/union)
  }
  # Weighted Jaccard Index (to take into account differences in lengths between A and B)
  else if(coef=="jaccardweight"){
    intersection = length(intersect(a, b))
    union = length(a) + length(b) - intersection
    maxj = min(length(a),length(b))/max(length(a), length(b))
    return (intersection/(union*maxj))
  }
  # else if(coef=="overlapcoef"){
  #   # cat("\n- Computing overlap coefficient -\n")
  #   intersection = length(intersect(a, b))
  #   denominator = min(length(a),length(b))
  #   return (intersection/denominator)
  # }
}
```




# 3. COEXPRESSION GENE LISTS (Sup Fig 10B)



# SESSION INFO
```{r}
sessionInfo()
```


