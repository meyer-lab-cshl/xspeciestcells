---
title: "Figure 7 - CD1d and SFR expression in human and murine thymus"
author: "Salomé Carcy"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true

---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 5,
  fig.height = 5,
  warning = FALSE,
  message = FALSE,
  attr.output='style="max-height: 300px;"',
  root.dir = "~/Projects/HumanThymusProject/"
)
```




# IMPORT

## Import librairies
```{r import-librairies}
library(ggplot2)
library(RColorBrewer)
library(cowplot)
library(tidyverse)
library(dplyr)
library(Seurat)
library(SCpubr)
library(patchwork)
library(scico)

setwd("~/Projects/HumanThymusProject/")
source("~/Projects/HumanThymusProject/scripts/colors_universal.R")
```


## Import data
The human and murine thymic seurat objects come from the Thymic Atlas generated by [Park et al.](https://www.science.org/doi/10.1126/science.aay3224). See script [download_park_thymic_atlas.Rmd](./download_park_thymic_atlas.Rmd) for how we obtained these seurat objects with appropriate metadata.
```{r import-data}
# import human & murine thymic atlases
seur.human <- readRDS("./data_github/park_dataset/park_seurat_human.rds")
seur.mouse <- readRDS("./data_github/park_dataset/park_seurat_mouse.rds")
```




# HUMAN
## Adapt cell annotation
```{r hu-cell-annotation}
# remove parathyroid cells
seur.human <- subset(seur.human, Anno_level_3 != "Epi_GCM2")

# Create a new level of annotation
seur.human@meta.data$Anno_curated <- seur.human@meta.data$Anno_level_1
seur.human@meta.data$Anno_curated <- case_when(
  seur.human@meta.data$Anno_curated=="TEC" & seur.human@meta.data$Anno_level_3=="cTEC" ~ "cTEC",
  # seur.human@meta.data$Anno_curated=="TEC" & seur.human@meta.data$Anno_level_3%in%c("mTEC", "TEC(myo)", "TEC(neuro)") ~ "mTEC",
  seur.human@meta.data$Anno_curated=="TEC" & seur.human@meta.data$Anno_level_3=="mTEC" ~ "mTEC",
  seur.human@meta.data$Anno_curated=="TEC" & seur.human@meta.data$Anno_level_3!="cTEC" & seur.human@meta.data$Anno_level_3!="mTEC" ~ "TEC_other",
  seur.human@meta.data$Anno_curated=="T"   & seur.human@meta.data$Anno_level_2=="DN" ~ "DN",
  seur.human@meta.data$Anno_curated=="T"   & seur.human@meta.data$Anno_level_2=="DP" ~ "DP",
  seur.human@meta.data$Anno_curated=="T"   & seur.human@meta.data$Anno_level_2=="SP" ~ "SP",
  seur.human@meta.data$Anno_curated=="Innate_T"   & seur.human@meta.data$Anno_level_3=="NKT" ~ "SP",
  seur.human@meta.data$Anno_curated=="Innate_T"   & seur.human@meta.data$Anno_level_3=="γδT" ~ "γδT",
  seur.human@meta.data$Anno_curated=="Endo"  ~ "Endothelial",
  seur.human@meta.data$Anno_curated=="Ery"   ~ "Erythrocyte",
  seur.human@meta.data$Anno_curated=="Mesen" ~ "Mesenchymal",
  seur.human@meta.data$Anno_curated=="Mgk"   ~ "Megakaryocyte",
  .default=seur.human@meta.data$Anno_curated
)

# sanity checks
table(seur.human@meta.data$Anno_curated, useNA="ifany")
# expect:
# B               5,082                          
# Endo              115
# Ery               644
# HSC               501
# Innate_lymphoid 2,176
# γδT             2,582
# Mast              148
# Mesen          21,290
# Mgk                36
# Myeloid         4,801
# DN             42,474
# DP            108,418
# SP             50,476
# cTEC           10,156
# mTEC            6,448
# TEC_other         480
table(seur.human@meta.data[,c("Anno_curated", "Anno_level_1")], useNA="ifany")

# define order to plot clusters
seur.human@meta.data$Anno_curated <- factor(
  seur.human@meta.data$Anno_curated,
  levels = c(
    "DN",
    "DP",
    "SP",
    "γδT",
    "cTEC",
    "mTEC",
    "TEC_other",
    "Innate_lymphoid",
    "B",
    "Myeloid",
    "Mesenchymal",
    "HSC",
    "Mast",
    "Erythrocyte",
    "Megakaryocyte",
    "Endothelial"
  )
)
```

Determine which clusters are most abundant.
```{r hu-abundant-clusters}
# see how many cells there are per cluster
as.data.frame(table(seur.human$Anno_curated)) %>%
  mutate(totalcells=sum(Freq),
         percentcells=Freq*100/totalcells) %>%
  arrange(percentcells)

hu_clusters_abundant <- levels(seur.human@meta.data$Anno_curated)[!levels(seur.human@meta.data$Anno_curated) %in% c("Megakaryocyte",
                                                                                                                    "Endothelial",
                                                                                                                    "Mast",
                                                                                                                    "HSC",
                                                                                                                    "Erythrocyte")]

```


## UMAP with clusters (Fig 7E)
Plot UMAP with cluster annotation.
```{r hu-umap-fig7E-left}
celltypes_col <- c(
  "mTEC"            = "#CE3F37",
  "cTEC"            = "#8C6143",
  "TEC_other"= "#666666",
  "DN"              = "#FDCB89",
  "DP"              = "#9ecae1",
  "SP"              = "#7FC97F",
  "γδT"             = "#B6B1C9",
  "Mesenchymal"     = "#FEE791",
  "Myeloid"         = "#F2F59A",
  "B"               = "#2171b5",
  "Endothelial"     = "#7D449D",
  "Erythrocyte"     = "#CD1588",
  "HSC"             = "#9BB5A4",
  "Innate_lymphoid" = "#EDBB99",
  "Mast"            = "#D1B3BB",
  "Megakaryocyte"   = "#9ABDA4"
  )

# UMAP
Idents(seur.human) <- "Anno_curated"
fig7E_p1 <- do_DimPlot(
    seur.human,
    reduction = "umap",
    idents.keep = hu_clusters_abundant,
    na.value = "grey90",
    legend.position = "right",
    legend.ncol = 1,
    font.size = 30,
    legend.icon.size = 10
  ) +
    scale_color_manual(values = celltypes_col)

# if needed to rasterise to export plot
# fig7E_p1 <- ggrastr::rasterise(fig7E_p1, layers = "Point", dpi = 300)
```

Plot _CD1D_ expression on `FeaturePlot`.
```{r hu-umap-fig7E-right}
# Plot CD1d expression
fig7E_p2 <- do_FeaturePlot(
    seur.human,
    features = "CD1D",
    order = T,
    plot.title = "CD1D expression",
    border.color = "black",
    border.size = 2,
    reduction = "umap",
    pt.size = 1.2,
    legend.position = "right",
    font.size = 30
  ) &
    scale_colour_scico(
      palette = "lapaz",
      alpha = 0.8,
      begin = 0.1,
      end = 0.85,
      direction = -1
    )

# if needed to rasterise to export plot
# fig7E_p2 <- ggrastr::rasterise(fig7E_p2, layers = "Point", dpi = 300)
```

Combine plots (Fig 7E).
```{r hu-umap-fig7E-combined, fig.width=12, fig.height=5}
fig7E_p1 | fig7E_p2
```


## Dotplot (Fig7F)
To note, in the manuscript, several clusters were removed (HSC, Mast, Erythrocyte, Megakaryocyte, Endothelial) because very few cells were captured, and they had very little level of _CD1D, SLAMF1_ or _SLAMF6_ detected.
```{r hu-dotplot-fig7F, fig.width=8}
DotPlot(
  seur.human,
  features = rev(c("CD1D", "SLAMF1", "SLAMF6")),
  group.by = "Anno_curated",
  cols = c("lightgrey", "darkred"),
  col.min = 0,
  dot.scale = 10
) +
  coord_flip() +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "")
```




# MOUSE
## Adapt cell annotation
```{r ms-cell-annotation}
# remove GEMM
seur.mouse <- subset(seur.mouse, age != "Rag1KO") # 34,073 cells

# adapt cell annotation
seur.mouse@meta.data$Anno_curated <- case_when(
  seur.mouse@meta.data$cell.types=="B"    ~ "B",
  seur.mouse@meta.data$cell.types %in% c("CD4+T", "CD8+T", "Treg", "αβT(entry)")  ~ "SP",
  seur.mouse@meta.data$cell.types %in% c("DN(P)", "DN(Q)")                        ~ "DN",
  seur.mouse@meta.data$cell.types %in% c("DP(P)", "DP(Q)")                        ~ "DP",
  seur.mouse@meta.data$cell.types=="Endo" ~ "Endothelial",
  seur.mouse@meta.data$cell.types=="Ery"  ~ "Erythrocyte",
  seur.mouse@meta.data$cell.types %in% c("Fb", "VSMC")                            ~ "Mesenchymal",
  seur.mouse@meta.data$cell.types %in% c("HSC", "NMP")                            ~ "HSC",
  seur.mouse@meta.data$cell.types %in% c("IELpA", "IELpB/NKT", "NK")              ~ "Innate_lymphoid",
  seur.mouse@meta.data$cell.types %in% c("DC1", "DC2", "aDC", "pDC")              ~ "Myeloid",
  seur.mouse@meta.data$cell.types %in% c("Mac", "Mono")                           ~ "Myeloid",
  seur.mouse@meta.data$cell.types %in% c("Epi_unknown", "TEC_early")              ~ "TEC_other",
  seur.mouse@meta.data$cell.types == "cTEC"  ~ "cTEC",
  seur.mouse@meta.data$cell.types == "mTEC"  ~ "mTEC",
  seur.mouse@meta.data$cell.types == "γδT"   ~ "γδT"
)

# sanity checks
table(seur.mouse@meta.data$Anno_curated, useNA="ifany")
table(seur.mouse@meta.data[,c("Anno_curated", "cell.types")], useNA="ifany")

# define order to plot
seur.mouse@meta.data$Anno_curated <- factor(
  seur.mouse@meta.data$Anno_curated,
  levels = c(
    "DN",
    "DP",
    "SP",
    "γδT",
    "cTEC",
    "mTEC",
    "TEC_other",
    "Innate_lymphoid",
    "B",
    "Myeloid",
    "Mesenchymal",
    "HSC",
    "Erythrocyte",
    "Endothelial"
  )
)
```

Determine which clusters are most abundant.
```{r ms-abundant-clusters}
# see how many cells there are per cluster
as.data.frame(table(seur.mouse$Anno_curated)) %>%
  mutate(totalcells=sum(Freq),
         percentcells=Freq*100/totalcells) %>%
  arrange(percentcells)
ms_clusters_abundant <- levels(seur.mouse@meta.data$Anno_curated)[!levels(seur.mouse@meta.data$Anno_curated) %in% c("Endothelial", "HSC", "Erythrocyte")]
```


## UMAP with clusters (Fig7A)
Plot UMAP with cluster annotation.
```{r ms-umap-fig7A-left}
fig7A_p1 <- do_DimPlot(
  seur.mouse,
  reduction = "umap",
  group.by = "Anno_curated",
  idents.keep = ms_clusters_abundant,
  na.value = "grey90",
  legend.position = "right",
  legend.ncol = 1,
  font.size = 30,
  legend.icon.size = 10
) +
  scale_color_manual(values = celltypes_col)

# if needed to rasterise to export plot
# fig7A_p1 <- ggrastr::rasterise(fig7A_p1, layers="Point", dpi=300)
```

Plot _Cd1d1_ expression on `FeaturePlot`.
```{r ms-umap-fig7A-right}
fig7A_p2 <- do_FeaturePlot(
  seur.mouse,
  features = "Cd1d1",
  plot.title = "Cd1d1 expression",
  order = T,
  border.color = "black",
  border.size = 2,
  reduction = "umap",
  pt.size = 1.2,
  legend.position = "right",
  font.size = 30
) &
  scale_colour_scico(
    palette = "lapaz",
    alpha = 0.8,
    begin = 0.1,
    end = 0.85,
    direction = -1
  )

# if needed to rasterise to export plot
# fig7A_p2 <- ggrastr::rasterise(fig7A_p2, layers="Point", dpi=300)
```

Combine plots (Fig 7A).
```{r ms-umap-fig7A-combined, fig.width=12, fig.height=5}
fig7A_p1 | fig7A_p2
```



## Dotplot (Fig7B)
```{r ms-dotplot-fig7B, fig.width=8}
DotPlot(
  seur.mouse,
  features = rev(c("Cd1d1", "Slamf1", "Slamf6")),
  group.by = "Anno_curated",
  cols = c("lightgrey", "darkred"),
  col.min = 0,
  dot.scale = 10
) +
  coord_flip() +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "")
```




# SESSION INFO
```{r}
sessionInfo()
```