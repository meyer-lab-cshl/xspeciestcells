---
title: "Human data - evaluate clusters based on k.param, # PCs and resolution"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(root.dir = "~/Projects/20220809_Thymic-iNKT-CrossSpecies/scripts/human-thymus/")
```


## 1. Import

```{r import-librairies, message=FALSE}
# Libraries
library(ggplot2)
library(cowplot)
library(Seurat)
library(SeuratWrappers)
# library(harmony)
library(tidyverse)
library(scclusteval)
```

```{r import-data}
# Import data
seur.human <- readRDS("~/Projects/20220809_Thymic-iNKT-CrossSpecies/data/raw_data/human_data/filtered_seurat_Harmony_07-22-22.RDS")
subsample_idents  <- readRDS("../../data/04_HumanNKTdata/scclusteval/gather_subsample.rds")
fullsample_idents <- readRDS("../../data/04_HumanNKTdata/scclusteval/gather_full_sample.rds")


# Take quick peek at the data
print(seur.human) # 79,801 cells and 34,778 genes
# seur.human@meta.data

table(fullsample_idents$pc)
table(fullsample_idents$resolution)
table(fullsample_idents$k_param)
```


## 2. Trying scClustEval on 5k PBMC data

Take a quick look at the PBMC 5k data
```{r}
# Import data
pbmc <- readRDS("../../data/07_scClustEval/pbmc/pbmc_5k_v3_label_transfered_from_10k.rds")
subsample_idents<- readRDS("../../data/07_scClustEval/pbmc/output_snakemake/gather_subsample.rds")
fullsample_idents<- readRDS("../../data/07_scClustEval/pbmc/output_snakemake/gather_full_sample.rds")

# pbmc@meta.data
```


Explore full dataset

```{r}
## how many PCs to include
ElbowPlot(pbmc, ndims = 40)

# a tibble with a list column
fullsample_idents
# fullsample_idents[1,]$original_ident_full[[1]] # original_ident_full is the vector of cells with the cluster number they are assigned to.

## how many clusters for each different comibination of parameter set?
fullsample_idents %>%
  mutate(cluster_number = purrr::map_dbl(original_ident_full, ~length(unique(.x))))

###_________________________________________
# HEATMAPS
# what's the relationship of clusters between k_param 8, 20, 100, with same pc=20 and resolution = 0.6

# Get the row numbers
fullsample_idents %>% mutate(id = row_number()) %>%
  filter(pc == 20, resolution == 0.6, k_param %in% c(8, 20, 100))

## x-axis is k_param = 20, and y-axis is k_param = 8
PairWiseJaccardSetsHeatmap(fullsample_idents$original_ident_full[[2]],
                           fullsample_idents$original_ident_full[[11]],
                           show_row_dend = F, show_column_dend = F,
                           cluster_row = T, cluster_column =T)

## x-axis is k_param = 100, and y-axis is k_param = 8
PairWiseJaccardSetsHeatmap(fullsample_idents$original_ident_full[[2]],
                           fullsample_idents$original_ident_full[[29]],
                           show_row_dend = F, show_column_dend = F,
                           cluster_row = T, cluster_column =T)

# The k.param in the k-nearest neighbor algorithm after which a SNN graph is constructed. This parameter determines the resolution of the clustering where a bigger k yields a more interconnected graph and bigger clusters. We see if we increase the k param to 100, we get fewer number of total number of clusters.

###_________________________________________
# DIMENSION REDUCTION
# Letâ€™s check how the clusters are splitting when we increase the k.param.
k8_ident <- fullsample_idents %>%
  filter(pc == 20, resolution == 0.6, k_param == 8)  %>%
  pull(original_ident_full) %>%
  `[[`(1)
pbmc <- AddMetaData(pbmc, metadata = k8_ident, col.name = "res0.6_k8")

k100_ident <- fullsample_idents %>%
  filter(pc == 20, resolution == 0.6, k_param == 100)  %>%
  pull(original_ident_full) %>%
  `[[`(1)
pbmc <- AddMetaData(pbmc, metadata = k100_ident, col.name = "res0.6_k100")

DimPlot(pbmc, reduction = "umap", label = TRUE, group.by = "res0.6_k8", repel = TRUE) + ggtitle("k_param 8") + NoLegend() |
  DimPlot(pbmc, reduction = "umap", label = TRUE, group.by = "res0.6_k100", repel = TRUE) + ggtitle("k_param 100") + NoLegend()

# Check the clusters vs the predicted cell types at k = 8
PairWiseJaccardSetsHeatmap(set_names(pbmc@meta.data$res0.6_k8, nm=colnames(pbmc)),
                           set_names(pbmc@meta.data$predicted.id, nm=colnames(pbmc)),
                           show_row_dend = F, show_column_dend = F,
                           cluster_row = F, cluster_column =F)
PairWiseJaccardSetsHeatmap(set_names(pbmc@meta.data$res0.6_k100, nm=colnames(pbmc)),
                           set_names(pbmc@meta.data$predicted.id, nm=colnames(pbmc)),
                           show_row_dend = F, show_column_dend = F,
                           cluster_row = F, cluster_column =F)
# when the k_param is big (100), many cell types are merged together.


###_________________________________________
# SILHOUETTE PLOTS
## change idents to cluster id when k is 8
Idents(pbmc)<- pbmc@meta.data$res0.6_k8
silhouette_scores<- CalculateSilhouette(pbmc, dims = 1:20)
sil_p1<- SilhouetteRainCloudPlot(silhouette_scores) + ggtitle("k_param 8")

## check silhouette score when k is 100
Idents(pbmc)<- pbmc@meta.data$res0.6_k100
silhouette_scores<- CalculateSilhouette(pbmc, dims = 1:20)
sil_p2<- SilhouetteRainCloudPlot(silhouette_scores) + ggtitle("k_param 100")

sil_p1 / sil_p2

# cluster 5 (k=100) split into clusters 7 and 12 (k=8)
# silhouette width for cluster 5 (k=100) is higher than clusters 7 and 12 (k=8), suggesting that k=100 is a better option?
```


Explore the subsampled data

```{r pbmc-subsampled-data}

```




## 2. Explore full dataset

```{r}
# how many PCs to include
ElbowPlot(seur.human)

# a tibble with a list column
fullsample_idents

# what's the relationship of clusters between resolution 0.05, 0.1 and 0.3 with the same and k_param
fullsample_idents %>% mutate(id = row_number()) %>%
  filter(pc == 150, resolution == 0.8, k_param == 10)

## x-axis is resolution of 0.1, and y-axis is resolution of 0.05
PairWiseJaccardSetsHeatmap(fullsample_idents$original_ident_full[[6]],
                           fullsample_idents$original_ident_full[[7]],
                           show_row_dend = F, show_column_dend = F,
                           cluster_row = F, cluster_column =F)
```

