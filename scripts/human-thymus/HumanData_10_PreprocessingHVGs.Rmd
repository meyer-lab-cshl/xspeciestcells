---
title: "Human T cell data - Play with HVGs for integrated data"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```




## 1. IMPORT

```{r import-librairies, message=FALSE}
library(ggplot2)
library(cowplot)
library(tidyverse)
library(dplyr)
library(Seurat)
library(RColorBrewer)
library(harmony)
# library(SingleCellExperiment)
```

```{r import-data}
# Import seurat object
seur.human <- readRDS("~/Projects/HumanThymusProject/data/raw_data/human_data/filtered_seurat_harmony.11.22.22.RDS")

# Sanity check
print(seur.human) # 81,378 cells (it's the whole seurat object)

# Quick visualization
DimPlot(seur.human, reduction="UMAP_50", group.by="new_clusters")+
  scale_color_manual(values=colorRampPalette(brewer.pal(12,"Paired"))(18))

# Check if mitochondrial & ribosomal genes still in the count data
# rownames(seur.human)[stringr::str_detect(rownames(seur.human), "MT")]
# rownames(seur.human)[stringr::str_detect(rownames(seur.human), "RP")] # ribosomal genes still present

# Cell type composition per cluster
ggplot(seur.human@meta.data[,c("cell.ident", "new_clusters")] %>% group_by(cell.ident, new_clusters) %>% count(),
       aes(x=new_clusters, y=n, fill=cell.ident))+
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values=brewer.pal(7,"Paired")) +
  labs(x="", y="", title = "2000 HVGs (total data)")
```




## 2. QUALITY CONTROL

```{r qc}
# Make seurat object with raw counts only
counts <- seur.human@assays$RNA@counts
metadata <- seur.human@meta.data

# Remove clusters in metadata
metadata[,c("RNA_snn_res.0.7", "seurat_clusters", "RNA_snn_res.1.2")] <- NULL
colnames(metadata)[14] <- "old_clusters" # rename Laurent's clusters to "old_clusters"

# Create seurat object
seur.raw <- CreateSeuratObject(counts=counts, meta.data=metadata, min.cells=10) # keep genes expressed in at least 10 cells


# Look at qc measures per batch & donor
VlnPlot(seur.raw, features="percent.mt",   group.by="Batch", split.by="Donor") + labs(x="Batch", fill="Donor")
VlnPlot(seur.raw, features="nFeature_RNA", group.by="Batch", split.by="Donor") + labs(x="Batch", fill="Donor")
VlnPlot(seur.raw, features="nCount_RNA",   group.by="Batch", split.by="Donor") + labs(x="Batch", fill="Donor")

# Split seurat object to find percent.mt outliers per batch (& subset seurat object)
seur.list <- SplitObject(seur.raw, split.by = "Batch")
seur.list <- lapply(X = seur.list, FUN = function(x) {
  threshold <- attr(scuttle::isOutlier(x@meta.data$percent.mt, type="higher"), "thresholds")["higher"]
  print(threshold)
  x <- subset(x, subset= percent.mt<threshold)
})
# Combine seurat object back together
seur.filt <- reduce(seur.list, function(x, y){
  merge(x = x, y = y, add.cell.ids = NULL, merge.data = T)
})

# Sanity check
VlnPlot(seur.filt, features="percent.mt",   group.by="Batch", split.by="Donor") + labs(x="Batch", fill="Donor", title="post-filtering")

# save for running seurat integration on Elzar
# saveRDS(seur.filt, "~/Projects/HumanThymusProject/data/CLUSTER/seurat-integration/input/seur_filt_22-12-19.rds")
```




## 3. INTEGRATION HARMONY PIPELINE (lognorm)

Following seurat standard pipeline, and then [integrating with Harmony](https://htmlpreview.github.io/?https://github.com/satijalab/seurat.wrappers/blob/master/docs/harmony.html)

### 3.1. INTEGRATION WITH HVGs SELECTED ON MERGED DATA

#### 3.1.1. Preprocess

```{r harmony-preprocess}
# Start on QC data
seur.filt <- readRDS("~/Projects/HumanThymusProject/data/CLUSTER/seurat-integration/input/seur_filt_22-12-19.rds")


# Run standard workflow for PCA
seur.norm <- NormalizeData(seur.filt)
seur.norm <- FindVariableFeatures(seur.norm, selection.method="vst", nfeatures=5000)
seur.norm <- ScaleData(seur.norm)
seur.norm <- RunPCA(seur.norm, npcs=50, verbose=FALSE)
ElbowPlot(seur.norm, ndims=50, reduction="pca")
# DimPlot(seur.norm, reduction="pca", group.by=c("Tissue", "Batch", "Method"))


# Integrate with Harmony
seur.harmony <- RunHarmony(seur.norm,
                           reduction = "pca",
                           max.iter.harmony=30,
                           group.by.vars = c("Method", "Batch")) # converged in 2 iterations
DimPlot(seur.harmony, reduction="pca", group.by="Batch") | DimPlot(seur.harmony, reduction="harmony", group.by="Batch")
DimPlot(seur.harmony, reduction="pca", group.by="Method") | DimPlot(seur.harmony, reduction="harmony", group.by="Method")
# ElbowPlot(seur.harmony, ndims=50, reduction="harmony")


# UMAP & Clustering
seur.harmony <- RunUMAP(seur.harmony, reduction = "harmony", dims = 1:20, n.neighbors=50)
seur.harmony <- FindNeighbors(seur.harmony, reduction = "harmony", dims = 1:20)
seur.harmony <- FindClusters(seur.harmony, resolution = 1)

# Re-order clusters
# table(seur.harmony@meta.data[,c("old_clusters", "RNA_snn_res.1")])
seur.harmony@meta.data$seurat_clusters <- case_when(
  seur.harmony@meta.data$RNA_snn_res.1 == 0 ~ 14,
  seur.harmony@meta.data$RNA_snn_res.1 == 1 ~ 15,
  seur.harmony@meta.data$RNA_snn_res.1 == 2 ~ 13,
  seur.harmony@meta.data$RNA_snn_res.1 == 3 ~ 10,
  seur.harmony@meta.data$RNA_snn_res.1 == 4 ~ 5,
  seur.harmony@meta.data$RNA_snn_res.1 == 5 ~ 11,
  seur.harmony@meta.data$RNA_snn_res.1 == 6 ~ 8,
  seur.harmony@meta.data$RNA_snn_res.1 == 7 ~ 12,
  seur.harmony@meta.data$RNA_snn_res.1 == 8 ~ 16,
  seur.harmony@meta.data$RNA_snn_res.1 == 9 ~ 4,
  seur.harmony@meta.data$RNA_snn_res.1 == 10 ~ 7,
  seur.harmony@meta.data$RNA_snn_res.1 == 11 ~ 6,
  seur.harmony@meta.data$RNA_snn_res.1 == 12 ~ 3,
  seur.harmony@meta.data$RNA_snn_res.1 == 13 ~ 9,
  seur.harmony@meta.data$RNA_snn_res.1 == 14 ~ 0,
  seur.harmony@meta.data$RNA_snn_res.1 == 15 ~ 1,
  seur.harmony@meta.data$RNA_snn_res.1 == 16 ~ 2,
)
# table(seur.harmony@meta.data[,c("seurat_clusters", "RNA_snn_res.1")]) # sanity check
```

#### 3.1.2. Visualization

```{r harmony-visualization}
# Visualization
DimPlot(seur.harmony, reduction = "umap", group.by = "Batch")
DimPlot(seur.harmony, reduction = "umap", group.by = "Tissue")
DimPlot(seur.harmony, reduction = "umap", group.by = "cell.ident") +
  scale_color_manual(values=brewer.pal(7,"Paired"))
DimPlot(seur.harmony, reduction = "umap", group.by="seurat_clusters", label = TRUE, repel = TRUE)+
  scale_color_manual(values=colorRampPalette(brewer.pal(12,"Paired"))(18))

# Cell type composition per cluster
ggplot(seur.harmony@meta.data[,c("cell.ident", "seurat_clusters")] %>% group_by(cell.ident, seurat_clusters) %>% count(),
       aes(x=seurat_clusters, y=n, fill=cell.ident))+
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values=brewer.pal(7,"Paired")) +
  labs(x="clusters", y="", title = "5000 HVGs (total data)")

# Is cluster 2 a Treg cluster?
# VlnPlot(seur.harmony, features=c("FOXP3"), group.by="seurat_clusters")
# ggsave("~/Downloads/foxp3.jpeg", width=8, height=5)
```



### 3.2. INTEGRATION WITH HVGs SELECTED ON EACH CELL TYPE

#### 3.2.1. Preprocess with global HVGs + thymic HVGs

```{r celltype-preprocess}
# Normalize data
seur.norm2 <- NormalizeData(seur.filt)


# Get HVGs from each cell type in thymus
getHVG <- function(seuratobject, cells, nfeatures=2000){
  # Subset seurat object
  cat("-- Subset seurat object --\n")
  seur.subset <- subset(seuratobject, subset = group.ident %in% cells)
  cat("Nb of cells in subset object:", dim(seur.subset)[2], "\n")
  # Find variable features
  seur.subset <- FindVariableFeatures(seur.subset, selection.method="vst", nfeatures=nfeatures)
  return(VariableFeatures(seur.subset))
}
# Call function to get HVGs for each cell lineage
hvg.cd4    <- getHVG(seuratobject=seur.norm2, nfeatures=2000, cells="CD4_Thymus")
hvg.cd8    <- getHVG(seuratobject=seur.norm2, nfeatures=2000, cells="CD8_Thymus")
hvg.nkt    <- getHVG(seuratobject=seur.norm2, nfeatures=2000, cells="NKT_Thymus")
hvg.mait   <- getHVG(seuratobject=seur.norm2, nfeatures=2000, cells="MAIT_Thymus")
hvg.gdt    <- getHVG(seuratobject=seur.norm2, nfeatures=2000, cells="GD_Thymus")
# hvg.thymus <- getHVG(seuratobject=seur.norm2, nfeatures=5000, cells=c("CD4_Thymus", "CD8_Thymus", "NKT_Thymus", "MAIT_Thymus", "GD_Thymus"))
# Compare how many genes in common
# table(hvg.cd4  %in% hvg.thymus)
# table(hvg.cd8  %in% hvg.thymus)
# table(hvg.nkt  %in% hvg.thymus)
# table(hvg.mait %in% hvg.thymus)
# table(hvg.gdt  %in% hvg.thymus)


# DEFINE VARIABLE FEATURES FOR SEURAT OBJECT
# get 2000 global HVGs
seur.norm2 <- FindVariableFeatures(seur.norm2, selection.method="vst", nfeatures=2000)
# add the thymic-specific HVGs
hvg.thymicells <- unique(c(hvg.cd4, hvg.cd8, hvg.nkt, hvg.mait, hvg.gdt))
# length(hvg.thymicells) # 3204 HVGs (nfeatures=1000); 5862 HVGs (nfeatures=2000)
# table(hvg.thymicells %in% VariableFeatures(seur.norm2), useNA="ifany") # 1806 (nfeatures=1000) or 4147 (nfeatures=2000) are not in the 2000 global HVGs
hvg.final <- unique(c(hvg.thymicells, VariableFeatures(seur.norm2)))
# length(hvg.final) # 3806 HVGs
VariableFeatures(seur.norm2) <- hvg.final


# CONTINUE PREPROCESSING
seur.norm2 <- ScaleData(seur.norm2)
seur.norm2 <- RunPCA(seur.norm2, npcs=50, verbose=FALSE)
# ElbowPlot(seur.norm2, ndims=50, reduction="pca")
# DimPlot(seur.norm2, reduction="pca", group.by=c("Tissue", "Batch", "Method"))
seur.harmony2 <- RunHarmony(seur.norm2, reduction = "pca", max.iter.harmony=30, group.by.vars = c("Method", "Batch")) # converged in 2 iterations
DimPlot(seur.harmony2, reduction="pca", group.by="Batch") | DimPlot(seur.harmony2, reduction="harmony", group.by="Batch")
DimPlot(seur.harmony2, reduction="pca", group.by="Method") | DimPlot(seur.harmony2, reduction="harmony", group.by="Method")
ElbowPlot(seur.harmony2, ndims=50, reduction="harmony")
seur.harmony2 <- RunUMAP(seur.harmony2, reduction = "harmony", dims = 1:20, n.neighbors=50)
seur.harmony2 <- FindNeighbors(seur.harmony2, reduction = "harmony", dims = 1:20)
seur.harmony2 <- FindClusters(seur.harmony2, resolution = 1)

# Re-order clusters
# table(seur.harmony2@meta.data[,c("old_clusters", "RNA_snn_res.1")])
seur.harmony2@meta.data$seurat_clusters <- case_when(
  seur.harmony2@meta.data$RNA_snn_res.1 == 0 ~ 14,
  seur.harmony2@meta.data$RNA_snn_res.1 == 1 ~ 16,
  seur.harmony2@meta.data$RNA_snn_res.1 == 2 ~ 11,
  seur.harmony2@meta.data$RNA_snn_res.1 == 3 ~ 5,
  seur.harmony2@meta.data$RNA_snn_res.1 == 4 ~ 13,
  seur.harmony2@meta.data$RNA_snn_res.1 == 5 ~ 8,
  seur.harmony2@meta.data$RNA_snn_res.1 == 6 ~ 12,
  seur.harmony2@meta.data$RNA_snn_res.1 == 7 ~ 4,
  seur.harmony2@meta.data$RNA_snn_res.1 == 8 ~ 10,
  seur.harmony2@meta.data$RNA_snn_res.1 == 9 ~ 7,
  seur.harmony2@meta.data$RNA_snn_res.1 == 10 ~ 15,
  seur.harmony2@meta.data$RNA_snn_res.1 == 11 ~ 9,
  seur.harmony2@meta.data$RNA_snn_res.1 == 12 ~ 3,
  seur.harmony2@meta.data$RNA_snn_res.1 == 13 ~ 0,
  seur.harmony2@meta.data$RNA_snn_res.1 == 14 ~ 17,
  seur.harmony2@meta.data$RNA_snn_res.1 == 15 ~ 1,
  seur.harmony2@meta.data$RNA_snn_res.1 == 16 ~ 6,
  seur.harmony2@meta.data$RNA_snn_res.1 == 17 ~ 2,
  seur.harmony2@meta.data$RNA_snn_res.1 == 18 ~ 18
)
# table(seur.harmony2@meta.data[,c("seurat_clusters", "RNA_snn_res.1")]) # sanity check
```

#### 3.2.2. Visualization

```{r celltype-visualization}
# Visualization
DimPlot(seur.harmony2, reduction = "umap", group.by = "Batch")
DimPlot(seur.harmony2, reduction = "umap", group.by = "Tissue")
DimPlot(seur.harmony2, reduction = "umap", group.by = "cell.ident") +
  scale_color_manual(values=brewer.pal(7,"Paired"))
DimPlot(seur.harmony2, reduction = "umap", group.by="seurat_clusters", label = TRUE, repel = TRUE)+
  scale_color_manual(values=colorRampPalette(brewer.pal(12,"Paired"))(19))

# Cell type composition per cluster
ggplot(seur.harmony2@meta.data[,c("cell.ident", "seurat_clusters")] %>% group_by(cell.ident, seurat_clusters) %>% count(),
       aes(x=seurat_clusters, y=n, fill=cell.ident))+
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values=brewer.pal(7,"Paired")) +
  labs(x="clusters", y="", title = "2000 HVGs (total data) + 4147 HVGs (thymic lineages)")

# Check marker genes cluster 6
ggplot(data = seur.harmony2@meta.data %>% group_by(seurat_clusters, group.ident) %>% count(),
       mapping=aes(x=seurat_clusters, y=n, fill=group.ident))+
  geom_bar(stat="identity", position="fill")+
  scale_fill_manual(values=colorRampPalette(brewer.pal(7,"Paired"))(14))
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/hvgall-and-thym_cellcomp.jpeg", width=10, height=6)
Idents(seur.harmony2) <- "seurat_clusters"
test <- FindMarkers(seur.harmony2, ident.1 = 6, ident.2=9, min.pct=0.25, logfc.threshold = 0.5)
test %>%
  filter(p_val_adj < 0.05) %>%
  arrange(-avg_log2FC)
# VlnPlot(seur.harmony2, features=c("IFI6", "IFIT3", "MX1"))
```

#### 3.2.3. Preprocess only with thymic HVGs

```{r thymic-hvg-preprocess}
# Normalize data
seur.norm3 <- NormalizeData(seur.filt)
length(hvg.thymicells) # sanity check: 3204 HVGs (nfeatures=1000); 5862 HVGs (nfeatures=2000)
VariableFeatures(seur.norm3) <- hvg.thymicells


# CONTINUE PREPROCESSING
seur.norm3 <- ScaleData(seur.norm3)
seur.norm3 <- RunPCA(seur.norm3, npcs=50, verbose=FALSE)
# ElbowPlot(seur.norm3, ndims=50, reduction="pca")
# DimPlot(seur.norm3, reduction="pca", group.by=c("Tissue", "Batch", "Method"))
seur.harmony3 <- RunHarmony(seur.norm3, reduction = "pca", max.iter.harmony=30, group.by.vars = c("Method", "Batch")) # converged in 2 iterations
DimPlot(seur.harmony3, reduction="pca", group.by="Batch") | DimPlot(seur.harmony3, reduction="harmony", group.by="Batch")
DimPlot(seur.harmony3, reduction="pca", group.by="Method") | DimPlot(seur.harmony3, reduction="harmony", group.by="Method")
ElbowPlot(seur.harmony3, ndims=50, reduction="harmony")
seur.harmony3 <- RunUMAP(seur.harmony3, reduction = "harmony", dims = 1:20, n.neighbors=50)
seur.harmony3 <- FindNeighbors(seur.harmony3, reduction = "harmony", dims = 1:20)
seur.harmony3 <- FindClusters(seur.harmony3, resolution = 1)

# table(seur.harmony3@meta.data[,c("old_clusters", "RNA_snn_res.1")])
seur.harmony3@meta.data$seurat_clusters <- case_when(
  seur.harmony3@meta.data$RNA_snn_res.1 == 0 ~ 14,
  seur.harmony3@meta.data$RNA_snn_res.1 == 1 ~ 15,
  seur.harmony3@meta.data$RNA_snn_res.1 == 2 ~ 8,
  seur.harmony3@meta.data$RNA_snn_res.1 == 3 ~ 5,
  seur.harmony3@meta.data$RNA_snn_res.1 == 4 ~ 10,
  seur.harmony3@meta.data$RNA_snn_res.1 == 5 ~ 12,
  seur.harmony3@meta.data$RNA_snn_res.1 == 6 ~ 11,
  seur.harmony3@meta.data$RNA_snn_res.1 == 7 ~ 4,
  seur.harmony3@meta.data$RNA_snn_res.1 == 8 ~ 13,
  seur.harmony3@meta.data$RNA_snn_res.1 == 9 ~ 7,
  seur.harmony3@meta.data$RNA_snn_res.1 == 10 ~ 6,
  seur.harmony3@meta.data$RNA_snn_res.1 == 11 ~ 9,
  seur.harmony3@meta.data$RNA_snn_res.1 == 12 ~ 0,
  seur.harmony3@meta.data$RNA_snn_res.1 == 13 ~ 3,
  seur.harmony3@meta.data$RNA_snn_res.1 == 14 ~ 17,
  seur.harmony3@meta.data$RNA_snn_res.1 == 15 ~ 1,
  seur.harmony3@meta.data$RNA_snn_res.1 == 16 ~ 2,
  seur.harmony3@meta.data$RNA_snn_res.1 == 17 ~ 16
)
# table(seur.harmony3@meta.data[,c("seurat_clusters", "RNA_snn_res.1")]) # sanity check


# Visualization
DimPlot(seur.harmony3, reduction = "umap", group.by = "Batch")
DimPlot(seur.harmony3, reduction = "umap", group.by = "Tissue")
DimPlot(seur.harmony3, reduction = "umap", group.by = "cell.ident") +
  scale_color_manual(values=brewer.pal(7,"Paired"))
DimPlot(seur.harmony3, reduction = "umap", group.by="seurat_clusters", label = TRUE, repel = TRUE)+
  scale_color_manual(values=colorRampPalette(brewer.pal(12,"Paired"))(18))

# Cell type composition per cluster
ggplot(seur.harmony3@meta.data[,c("group.ident", "seurat_clusters")] %>% group_by(group.ident, seurat_clusters) %>% count(),
       aes(x=seurat_clusters, y=n, fill=group.ident))+
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values=colorRampPalette(brewer.pal(7,"Paired"))(14)) +
  labs(x="clusters", y="", title = "5862 HVGs (based on thymic lineages)")
# Check out cluster 16
Idents(seur.harmony3) <- "seurat_clusters"
test <- FindMarkers(seur.harmony3, ident.1 = 16, ident.2=9, min.pct=0.25, logfc.threshold = 0.5)
test %>%
  filter(p_val_adj < 0.05) %>%
  arrange(-avg_log2FC)
```

#### 3.2.4. Comparison

```{r comparison}
# Comparison by UMAP, color by cell lineage
col <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FF7F00")
DimPlot(seur.human, reduction = "UMAP_50", group.by = "cell.ident") +
  scale_color_manual(values=col) + labs(title="2000 HVGs (total data)") |
DimPlot(seur.harmony, reduction = "umap", group.by = "cell.ident") +
  scale_color_manual(values=col) + labs(x="umap50_1", y="umap50_2", title="5000 HVGs (total data)") |
DimPlot(seur.harmony2, reduction = "umap", group.by = "cell.ident") +
  scale_color_manual(values=col) + labs(x="umap50_1", y="umap50_2", title="2000 HVGs (total data) + 4147 HVGs (thymic lineages)") |
DimPlot(seur.harmony3, reduction = "umap", group.by = "cell.ident") +
  scale_color_manual(values=col) + labs(x="umap50_1", y="umap50_2", title="5862 HVGs (based on thymic lineages)")
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_with_thymic_hvg.jpeg", width=24, height=6)


# Comparison by UMAP, color by clusters
col2 <- colorRampPalette(brewer.pal(12,"Paired"))(19)
DimPlot(seur.human, reduction = "UMAP_50", group.by = "new_clusters", label=T) +
  scale_color_manual(values=col2) + labs(title="2000 HVGs (total data)") |
DimPlot(seur.harmony, reduction = "umap", group.by = "seurat_clusters", label=T) +
  scale_color_manual(values=col2) + labs(x="umap50_1", y="umap50_2", title="5000 HVGs (total data)") |
DimPlot(seur.harmony2, reduction = "umap", group.by = "seurat_clusters", label=T) +
  scale_color_manual(values=col2) + labs(x="umap50_1", y="umap50_2", title="2000 HVGs (total data) + 4147 HVGs (thymic lineages)") |
DimPlot(seur.harmony3, reduction = "umap", group.by = "seurat_clusters", label=T) +
  scale_color_manual(values=col2) + labs(x="umap50_1", y="umap50_2", title="5862 HVGs (based on thymic lineages)")
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_with_thymic_hvg2.jpeg", width=24, height=6)


# Comparison by UMAP, color by tissue
col3 <- c("#ef3b2c", "#6baed6")
DimPlot(seur.human, reduction = "UMAP_50", group.by = "Tissue", label=T) +
  scale_color_manual(values=col3) + labs(title="2000 HVGs (total data)") |
DimPlot(seur.harmony, reduction = "umap", group.by = "Tissue", label=T) +
  scale_color_manual(values=col3) + labs(x="umap50_1", y="umap50_2", title="5000 HVGs (total data)") |
DimPlot(seur.harmony2, reduction = "umap", group.by = "Tissue", label=T) +
  scale_color_manual(values=col3) + labs(x="umap50_1", y="umap50_2", title="2000 HVGs (total data) + 4147 HVGs (thymic lineages)") |
DimPlot(seur.harmony3, reduction = "umap", group.by = "Tissue", label=T) +
  scale_color_manual(values=col3) + labs(x="umap50_1", y="umap50_2", title="5862 HVGs (based on thymic lineages)")
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_with_thymic_hvg5.jpeg", width=24, height=6)


# Comparison of clusters
# table(rownames(seur.harmony@meta.data) == rownames(seur.harmony2@meta.data)) # sanity check
# table(rownames(seur.harmony@meta.data) == rownames(seur.harmony3@meta.data)) # sanity check
df <- seur.harmony@meta.data[,c("old_clusters", "seurat_clusters")] %>%
  rename(laurent=old_clusters, hvg5000=seurat_clusters) %>%
  mutate(laurent=factor(laurent, levels=0:17))
df <- cbind(df, seur.harmony2@meta.data$seurat_clusters, seur.harmony3@meta.data$seurat_clusters) %>%
  rename(hvg2000_thy4147="seur.harmony2@meta.data$seurat_clusters",
         thy5862="seur.harmony3@meta.data$seurat_clusters") %>%
  group_by(laurent, hvg5000, hvg2000_thy4147, thy5862) %>%
  count()

flowplot <- function(colorscale=colorRampPalette(brewer.pal(12,"Paired"))(18)){
  ggplot(df, aes(y = n, axis1 = laurent, axis2 = hvg5000, axis3=hvg2000_thy4147, axis4=thy5862)) +
    geom_alluvium(aes(fill=laurent), width = 1/12, lode.guidance="zigzag") +
    geom_stratum(width = 1/12, fill = "black", color = "grey") +
    geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
    scale_x_discrete(limits = c("2000 HVGs (total data)",
                                "5000 HVGs (total data)",
                                "2000 HVGs (total data) + 4147 HVGs (thymic lineages)",
                                "5862 HVGs (based on thymic lineages)"), expand = c(.05, .05)) +
    scale_fill_manual(values=colorscale) +
    labs(title="Comparison cluster assignment", y="#cells")
}
flowplot()
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_with_thymic_hvg3.jpeg", width=15, height=10)


# Cell type composition per cluster
cellcomp <- function(seurobj, title){
  ggplot(seurobj@meta.data[,c("cell.ident", "seurat_clusters")] %>% group_by(cell.ident, seurat_clusters) %>% count(),
       aes(x=seurat_clusters, y=n, fill=cell.ident))+
    geom_bar(position="fill", stat="identity") +
    scale_fill_manual(values=brewer.pal(7,"Paired")) +
    labs(x="clusters", y="", title = title)
}
# Plot
ggplot(seur.human@meta.data[,c("cell.ident", "new_clusters")] %>% group_by(cell.ident, new_clusters) %>% count(),
       aes(x=new_clusters, y=n, fill=cell.ident))+
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values=brewer.pal(7,"Paired")) +
  labs(x="", y="", title = "2000 HVGs (total data)") |
  cellcomp(seur.harmony, title="5000 HVGs (total data)") |
  cellcomp(seur.harmony2, title="2000 HVGs (total data) + 4147 HVGs (thymic lineages)") |
  cellcomp(seur.harmony3, title="5862 HVGs (based on thymic lineages)")
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_with_thymic_hvg4.jpeg", width=24, height=6)
```


Little deep-dive on cluster 6
```{r comparison-clus6}
# Highlight cluster 6 on alluvial plot
flowplot(colorscale=c(rep("#bdbdbd", 6), "#99000d", rep("#bdbdbd", 11))) # cluster 6
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_with_thymic_hvg_clus6.jpeg", width=15, height=10)

# Highlight cluster 6 on umaps
clus6 <- WhichCells(seur.human, idents=6)
DimPlot(seur.human, reduction = "UMAP_50", cells.highlight=clus6) +
  labs(title="2000 HVGs (total data)") + theme(legend.position="none") |
DimPlot(seur.harmony, reduction = "umap", cells.highlight=clus6) +
  labs(x="umap50_1", y="umap50_2", title="5000 HVGs (total data)") + theme(legend.position="none") |
DimPlot(seur.harmony2, reduction = "umap", cells.highlight=clus6) +
  labs(x="umap50_1", y="umap50_2", title="2000 HVGs (total data) + 4147 HVGs (thymic lineages)") + theme(legend.position="none") |
DimPlot(seur.harmony3, reduction = "umap", cells.highlight=clus6) +
  labs(x="umap50_1", y="umap50_2", title="5862 HVGs (based on thymic lineages)") + theme(legend.position="none")
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/umap_clus6.jpeg", width=24, height=6)

# Check out marker genes of cluster 10 in seur.harmony (nfeatures=5000)
FindMarkers(seur.harmony, ident.1 = 10, min.pct = 0.25, logfc.threshold = 1.0, only.pos=T) %>%
  arrange(avg_log2FC)
```




## 4. PARK GENE SIGNATURES

### 4.1. Define function

```{r park-gene-signatures}
# Gene signatures from Park paper
parksignatures <- read.csv("~/Projects/HumanThymusProject/data/park_genesignatures.csv", row.names=1)
Egress <- list(c("KLF2", "CORO1A", "CCR7", "CXCR4", "CXCR6", "FOXO1", "CXCR3", "S1PR1", "S1PR4",
                 "S100A4", "S100A6", "EMP3"))


# Function to look at these gene signatures
signatures <- function(seuratobject=seur.human, scorelist=DN_score, scorename="DN_score", celltype="NKT"){
  # Add signatures to new seurat object
  seurat_scored <- AddModuleScore(object = seuratobject, features = scorelist, assay = "RNA", name = scorename)
  # Plot
  SCpubr::do_FeaturePlot(sample = seurat_scored, 
                         features = paste0(scorename, "1"),
                         plot.title = scorename,
                         reduction = "UMAP_50",
                         viridis_color_map = "inferno")
  ggsave(paste0("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/parksignatures_", scorename, ".jpeg"), width=10, height=10)
}
```


### 4.2. Plot

```{r park-gene-signatures2}
signatures(scorelist=list(parksignatures$DNp),        scorename="DNp_score") # 1 gene absent
signatures(scorelist=list(parksignatures$DNq),        scorename="DNq_score") # 3 genes
signatures(scorelist=list(parksignatures$DN_early),   scorename="DNearly_score") # 2 genes

signatures(scorelist=list(parksignatures$DPq),        scorename="DPq_score") # 3 genes absent
signatures(scorelist=list(parksignatures$DPp),        scorename="DPp_score") # 5 genes

signatures(scorelist=list(parksignatures$gdT),        scorename="gdT_score")
signatures(scorelist=list(parksignatures$abT_entry),  scorename="abT_entry_score") # 3 genes absent

signatures(scorelist=list(parksignatures$CD8aa1),     scorename="CD8aa1_score")
signatures(scorelist=list(parksignatures$CD8aa2),     scorename="CD8aa2_score") # 1 gene absent
signatures(scorelist=list(parksignatures$NKT),        scorename="NKT_score")

signatures(scorelist=list(parksignatures$T_agonist),  scorename="Tagonist_score") # 1 gene absent
signatures(scorelist=list(parksignatures$CD4T),       scorename="CD4T_score") # 1 gene
signatures(scorelist=list(parksignatures$Th17),       scorename="Th17_score") # 1 gene
signatures(scorelist=list(parksignatures$Treg),       scorename="Treg_score") # 2 genes
signatures(scorelist=list(parksignatures$Treg_diff),  scorename="Treg_diff_score") # 1 gene

signatures(scorelist=list(parksignatures$CD8T),       scorename="CD8T_score") # 1 gene absent

# cluster 6 T agonist?...
test <- AddModuleScore(object = seur.human, features = list(parksignatures$T_agonist),
                       assay = "RNA", name = "Tagonist_score")
VlnPlot(test, features="Tagonist_score1")+
  scale_fill_manual(values=colorRampPalette(brewer.pal(12,"Paired"))(18))
# ggsave("~/Projects/HumanThymusProject/data/human-thymus/HumanData_10_PreprocessingHVGs/parksignatures_Tagonist_score_vlnplot.jpeg", width=10, height=6)
```

